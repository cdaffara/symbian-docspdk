<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="Setting universal time and offset"/>
<meta name="DC.Relation" scheme="URI" content="GUID-F0C71D6E-CAF1-49CC-A697-FC1A810DF1D5.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-58035B49-2EAE-5144-B226-28AF2EDD62E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-4FCF605D-52D9-5B2D-80CF-80C940F680CA.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-F0C71D6E-CAF1-49CC-A697-FC1A810DF1D5.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Setting universal time and offset</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2520040 id2380831 id2380852 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-58035B49-2EAE-5144-B226-28AF2EDD62E7.html">Generic Application Support Guide</a> &gt; <a href="GUID-4FCF605D-52D9-5B2D-80CF-80C940F680CA.html">Time Zone Services</a> &gt; <a href="GUID-F0C71D6E-CAF1-49CC-A697-FC1A810DF1D5.html">Time Zone Services Tutorials</a> &gt; </div>
<h1 class="topictitle1">Setting
universal time and offset</h1>
<div>
<p>Internally, the kernel uses UTC (Coordinated Universal Time) and stores
an offset for the difference between UTC and local time which is made up of
both the time zone and any daylight saving time added. This removes the responsibility
for handling time zones and daylight saving from the kernel to a user side
"timezone" server. A positive offset indicates a time ahead of UTC: a negative
offset indicates a time behind UTC.</p>

<p>The API below is used to set and get the UTC offset values. </p>

<ul>
<li><p><a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-145F52E6-2A29-3FF1-8AD1-7009BE0074D7"><span class="apiname">User::SetUTCTime()</span></a></p>
</li>

<li><p><a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-68D881BA-E4BA-3795-90E0-236E07112325"><span class="apiname">User::SetUTCOffset()</span></a></p>
</li>

<li><p><a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-D1A4CF1D-1F4F-3745-BD3D-671925D16CD3"><span class="apiname">User::SetUTCTimeAndOffset()</span></a></p>
</li>

<li><p><a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-3CC64469-C1E1-330F-9B4D-B8F95957904F"><span class="apiname">User::UTCOffset()</span></a></p>
</li>

</ul>

<div class="note"><span class="notetitle">Note:</span> <p>Setting the UTC time and offset requires the <samp class="codeph">WriteDeviceData</samp> security
capability.</p>
</div>

<div class="section" id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-D4CD566E-3DF6-4F40-8821-304F45C75C54"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-D4CD566E-3DF6-4F40-8821-304F45C75C54"><!-- --></a><h2 class="sectiontitle">Customizing
the default time zone setting</h2>       <p>The local time zone is calculated
using an offset from UTC. <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-68D881BA-E4BA-3795-90E0-236E07112325"><span class="apiname">User::SetUTCOffset()</span></a> is used
to set the offset to the required value. This function is called by three
different components at boot up:  </p>
<ul>
<li><p><a href="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E.html#GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-C028BE6B-AE48-40AC-8D5F-BF1DED206450">EStart</a> -
sets the offset at the start of the boot process and then provides the correct
time for parts of the system that are initialized before the TimeZone and
Locale services are running. </p>
</li>

<li><p><a href="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E.html#GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-EB566340-35CD-445B-8F93-960BB4D35769">InitialiseLocale</a> -
sets and gets the locale information stored within the repository. This is
necessary if the TimeZoneServer is not included. </p>
</li>

<li><p><a href="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E.html#GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-6F418656-2D12-4090-90A3-C2DF3D749601">TimeZoneServer</a> -
is an optional service that device manufactures can choose to include. It
is recommended that the offset is set both here and within InitialiseLocale.
 </p>
</li>

</ul>
</div>

<div class="section" id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-C028BE6B-AE48-40AC-8D5F-BF1DED206450"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-C028BE6B-AE48-40AC-8D5F-BF1DED206450"><!-- --></a><h2 class="sectiontitle">EStart</h2><p>The
call in EStart is required for backwards compatibility with systems that do
not use the TimeZoneServer. The call in EStart also allows many parts of the
system to see the correct time before the timezone/locale services are up
and running. If the timezone offset is not set during startup then many components
may, for that period, see the wrong time.  </p>
<p> The data format for the
persisted locale data makes no allowance for daylight savings that are not
equal to one hour, but in new code the daylight savings flag is never used
(specifically because of this issue) and the offset is adjusted by the correct
amount instead.  </p>
<p> To alter the default time zone operation within <strong>EStart</strong>,
provide your own implementation of the EStart virtual function <a href="GUID-7A6C0343-7B98-3429-9162-4C0357594230.html#GUID-7A6C0343-7B98-3429-9162-4C0357594230__GUID-165D453E-8B09-3B22-96BC-076E01DB8F26"><span class="apiname">TFSStartup::LoadLocale()</span></a>.
See <a href="GUID-BFE1422D-3B4A-5B25-A757-B5B68D6390F8.html" title="This topic describes how to customize the Base Starter.">EStart: customizing
code</a>.   </p>
<p>The offset set through EStart is retrieved through <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-3CC64469-C1E1-330F-9B4D-B8F95957904F"><span class="apiname">User::UTCOffset()</span></a>.
 </p>
</div>

<div class="section" id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-EB566340-35CD-445B-8F93-960BB4D35769"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-EB566340-35CD-445B-8F93-960BB4D35769"><!-- --></a><h2 class="sectiontitle">InitialiseLocale</h2><p>InitialiseLocale
initializes and persists changes to the system locale settings. The system
locale data is persisted using the central repository. The executable <samp class="codeph">initialiseLocale.exe</samp> loads
the system locale data at device boot and ensures that changes to the system
locale data are persisted.   </p>
<p>Once <samp class="codeph">initialiseLocale.exe</samp> has
been loaded (as part of the system boot sequence) the contents of the system
locale data are initialized and any subsequent changes to the system locale
settings are persisted without any intervention from the application or component
making the changes.  </p>
<p/>
<p><strong>Changing System Locale Settings</strong></p>
<p>Create
an empty <samp class="codeph">TExtendedLocale</samp> object and use <samp class="codeph">LoadSystemSettings()</samp> to
get the settings from the repository, make changes and save them with <samp class="codeph">SaveSystemSettings()</samp>.
This function generates a notification for system locale changes so changes
to the locale information may not be immediate.  </p>
<p> For example, an application
that wishes to change the system time and date settings (without changing
any other locale settings) goes through the following steps: </p>
<ol>
<li id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-049A63A9-D3AB-4E88-AB94-EEBD61B15027"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-049A63A9-D3AB-4E88-AB94-EEBD61B15027"><!-- --></a><p>Create an empty instance
of <samp class="codeph">TExtendedLocale</samp>.</p>
<pre class="codeblock">TExtendedLocale myExtendedLocale;
</pre>
</li>

<li id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-362D9D13-2DAA-4A80-9EA1-ABE9E0EE8152"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-362D9D13-2DAA-4A80-9EA1-ABE9E0EE8152"><!-- --></a><p>Initialize it to the
current system settings.</p>
<pre class="codeblock">myExtendedLocale.LoadSystemSettings();
</pre>
</li>

<li id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-FC7F35DA-2A46-4AF2-A580-D9EF292A031B"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-FC7F35DA-2A46-4AF2-A580-D9EF292A031B"><!-- --></a><p>Change the time and
date settings locally.</p>
<pre class="codeblock">myExtendedLocale.LoadLocaleAspect( ELocaleTimeDateSettings, KLocaleDllTimeDateSettings );
</pre>
</li>

<li id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-B6C19192-C396-4A3E-A534-141AE5D8426B"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-B6C19192-C396-4A3E-A534-141AE5D8426B"><!-- --></a><p>Write the new settings
to the system locale data.</p>
<pre class="codeblock">myExtendedLocale.SaveSystemSettings();</pre>
</li>

</ol>
<p>The <strong>security capability</strong> <samp class="codeph">WriteDeviceData</samp> is
required to save settings.</p>
</div>

<div class="section" id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-6F418656-2D12-4090-90A3-C2DF3D749601"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-6F418656-2D12-4090-90A3-C2DF3D749601"><!-- --></a><h2 class="sectiontitle">TimeZoneServer</h2><p>The
time zone server simplifies the synchronisation between handsets in different
time zones. For example, if one handset is in the UK and another in the US
a meeting can be scheduled at the same time (UTC) and the local time is calculated
for each by the time zone server.  </p>
<p> The Time Zone Server converts UTC
to local time based on different time zones and DST rules, and publishes any
change to subscribing clients, for example the Calendar application. See <a href="GUID-A81C65CF-CF4E-571C-8080-9D387F46AAD6.html" title="This section explains the publish and subscribe concepts.">Publish and Subscribe</a>.</p>
<p>The
time zone server is an optional service that licensees can choose to include
otherwise another method can be used to supply the UTC offset, for example,
Network time update, see <a href="GUID-AA81AFA4-6FAC-3B0D-A082-BE0AEC58CCA8.html#GUID-AA81AFA4-6FAC-3B0D-A082-BE0AEC58CCA8__GUID-1676D1E4-AD15-3265-B1A8-1C7B9B56FB66"><span class="apiname">RMobilePhone::GetNITZInfo()</span></a>. Because
the time zone server may not be included in the product it is necessary to
persist the UTC offset as part of the locale data (<samp class="codeph">TLocale</samp>).
The time zone server persists the current time zone and updates the UTC offset
based on whether daylight savings applies or not.  </p>
<p> The following code
example should help to illustrate the interactions that may occur if <a href="GUID-1BD54E95-218F-3B43-B427-F9EA6DA9AB69.html"><span class="apiname">User:SetUTCOffset()</span></a> or <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-D1A4CF1D-1F4F-3745-BD3D-671925D16CD3"><span class="apiname">User::SetUTCTimeAndOffset()</span></a> are called while the time zone server is running.  </p>
<p>Preconditions
for this code are:</p>
<ul>
<li><p>The time zone server is not already running. </p>
</li>

<li><p>It is assumed that the current UTC offset is not 36000 seconds (10
hours). For describing this example, we will take the UTC to be 18000 seconds
(5 hours). </p>
</li>

</ul>
<pre class="codeblock">void MainL()
    {
    RTz tz;
    TTimeIntervalSeconds offsetWhenTzRunningInitial;
    TTimeIntervalSeconds offsetWhenTzRunningAfterSetting;
    TTimeIntervalSeconds offsetWhenTzNotRunningInitial;
    TTimeIntervalSeconds offsetWhenTzNotRunningAfterSetting;

    TInt err = tz.Connect();
    User::LeaveIfError( err );
    offsetWhenTzRunningInitial = User::UTCOffset(); 
    User::SetUTCOffset( 36000 );
    User::After( 1*1000*1000 );
    offsetWhenTzRunningAfterSetting = User::UTCOffset(); 
    tz.Close();

    offsetWhenTzNotRunningInitial = User::UTCOffset(); 
    User::SetUTCOffset( 36000 );
    offsetWhenTzNotRunningAfterSetting = User::UTCOffset(); 
    }</pre>
<p>Given the preconditions listed, the values for the offsets
retrieved are:</p>
<ol>
<li id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-9D41985D-620F-4954-897B-B2F2558304D1"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-9D41985D-620F-4954-897B-B2F2558304D1"><!-- --></a><p><samp class="codeph">offsetWhenTzRunningInitial</samp> 18000
(seconds). </p>
</li>

<li id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-89867FF7-27ED-4B48-9CCE-0A011F14DF43"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-89867FF7-27ED-4B48-9CCE-0A011F14DF43"><!-- --></a><p><samp class="codeph">offsetWhenTzRunningAfterSetting</samp> 18000
(seconds). </p>
</li>

<li id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-2A04B812-C409-4376-8964-856C75647D44"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-2A04B812-C409-4376-8964-856C75647D44"><!-- --></a><p><samp class="codeph">offsetWhenTzNotRunningInitial</samp> 18000
(seconds).</p>
</li>

<li id="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-5498BB66-8437-4A0A-A2D5-BE6E776A6810"><a name="GUID-27CB7E85-8E6F-456B-8B90-55A605A0085E__GUID-5498BB66-8437-4A0A-A2D5-BE6E776A6810"><!-- --></a><p><samp class="codeph">offsetWhenTzNotRunningAfterSetting</samp> 36000
(seconds).</p>
</li>

</ol>
<p>The value of <samp class="codeph">offsetWhenTzRunningAfterSetting</samp> is not
36000 as one might expect from just looking at the code. This is because the
time zone server observes the kernel setting of the UTC offset and when this
value is changed, it checks the current time zone and ensures that the offset
matches this value. The delay is placed in this example code to ensure that
the time zone server is given a chance to run and to change the value. </p>
<p>If
a call to <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-3CC64469-C1E1-330F-9B4D-B8F95957904F"><span class="apiname">User::UTCOffset()</span></a> were made before the call to <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-4FDD3CEB-9D30-33BD-BAF3-14A1E2D56B18"><span class="apiname">User::After()</span></a>,
then the value can be either 36000 or 18000 depending on the CPU load, presence
of other processes and their relative priorities. </p>
</div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-F0C71D6E-CAF1-49CC-A697-FC1A810DF1D5.html">Time Zone Services Tutorials</a></div>
</div>
</div>
   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>