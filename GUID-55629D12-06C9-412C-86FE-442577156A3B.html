<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="Implementing the CPosPrivacyNotifier Subclass"/>
<meta name="abstract" content="To use the Privacy Query and Notification API to create a notifier a licensee must first implement a single notifier class that derives from the Privacy Query and Notification API base class CPosPrivacyNotifier."/>
<meta name="description" content="To use the Privacy Query and Notification API to create a notifier a licensee must first implement a single notifier class that derives from the Privacy Query and Notification API base class CPosPrivacyNotifier."/>
<meta name="DC.Relation" scheme="URI" content="GUID-D4AB2D70-D49E-5F59-80F6-3D90F1D76BD5.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-7F476137-5E7F-5288-9F4A-6C20F0A1AD9B.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-710BC22B-E4F0-5E16-B970-E2D21F5571FC.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-CE970F0F-C922-516F-9D7E-EA1F4754A205.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-CDE5CC9D-F6DE-5A21-97C3-59A2F3398A15.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-63681C76-3E0A-5A7A-9723-93F4142A7E7E.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-D4AB2D70-D49E-5F59-80F6-3D90F1D76BD5.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-55629D12-06C9-412C-86FE-442577156A3B"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Implementing the CPosPrivacyNotifier Subclass</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-55629D12-06C9-412C-86FE-442577156A3B"><a name="GUID-55629D12-06C9-412C-86FE-442577156A3B"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2402590 id2402671 id2402731 id2402745 id2402794 id2402884 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-7F476137-5E7F-5288-9F4A-6C20F0A1AD9B.html">Location Based Services (LBS) Guide</a> &gt; <a href="GUID-710BC22B-E4F0-5E16-B970-E2D21F5571FC.html" title="The Location Request Management collection contains components that handle requests for location request information both from installed applications and from the network.">Location Request Management</a> &gt; <a href="GUID-CE970F0F-C922-516F-9D7E-EA1F4754A205.html" title="The Network Request Handler processes privacy and location requests received from the network.">Network Request Handler</a> &gt; <a href="GUID-CDE5CC9D-F6DE-5A21-97C3-59A2F3398A15.html" title="A privacy request is a request for permission to obtain the mobile device's location. Privacy requests are usually sent from the network to the mobile device as part of an MT-LR.">Privacy Requests</a> &gt; <a href="GUID-63681C76-3E0A-5A7A-9723-93F4142A7E7E.html" title="This section contains links to topics that explain how to create a Privacy Controller and Privacy Notifiers.">Privacy Request Tutorials</a> &gt; <a href="GUID-D4AB2D70-D49E-5F59-80F6-3D90F1D76BD5.html" title="This section gives guidance on how to create a Privacy Notifier using the Privacy Query and Notification API.">Using the Privacy Query and Notification API</a> &gt; </div>
<h1 class="topictitle1">Implementing
the CPosPrivacyNotifier Subclass</h1>
<div><p>To use the Privacy Query and Notification API to create a notifier
a licensee must first implement a single notifier class that derives from
the Privacy Query and Notification API base class <samp class="codeph">CPosPrivacyNotifier</samp>.</p>

<p>The <a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html"><span class="apiname">CPosPrivacyNotifier</span></a> subclass must implement the
virtual functions of the base class:     </p>

<ul>
<li><p><a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-33E317F9-A8C0-34AF-B17A-72D46B2E4DBD"><span class="apiname">CPosPrivacyNotifier::HandleNewRequestL()</span></a></p>
</li>

<li><p><a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-3417B07B-DE69-3719-8634-B979CBA77AFE"><span class="apiname">CPosPrivacyNotifier::HandleRequestCancelled()</span></a></p>
</li>

<li><p><a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-6D3C8687-6FEC-34FF-9846-1508C9DF4E72"><span class="apiname">CPosPrivacyNotifier::HandleAllRequestsCancelled()</span></a></p>
</li>

</ul>

<div class="section" id="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-F911F632-320C-4871-A385-BD01EBB13BB6"><a name="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-F911F632-320C-4871-A385-BD01EBB13BB6"><!-- --></a><h2 class="sectiontitle">Implementing HandleNewRequestL()</h2>              <p>New
privacy verification query and notification requests are received by the notifier
through <a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-33E317F9-A8C0-34AF-B17A-72D46B2E4DBD"><span class="apiname">CPosPrivacyNotifier::HandleNewRequestL()</span></a>. The example
code below shows how the notifier handles requests sequentially by simply
calling a helper function <a href="GUID-BEB6299A-9BA4-36BB-8E43-52855B753A04.html"><span class="apiname">HandleNextRequestL()</span></a> to get the
next request.</p>
     <pre class="codeblock">void CMyPrivacyNotifier::HandleNewRequestL(TPosQNRequestId /*aRequestId*/)
    {
    if (iIsBusy) // TBool flag which specifies if the notifier is already
        {        // handling a request. If it is, do nothing for now.
        return;
        }

    // Handle the request
    HandleNextRequestL();
    }</pre>
</div>

<div class="section" id="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-DECB2165-6C1E-4D1D-BF4B-8344DB0CA185"><a name="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-DECB2165-6C1E-4D1D-BF4B-8344DB0CA185"><!-- --></a><h2 class="sectiontitle">HandleNextRequestL() </h2><p>The example code below shows
how the notifier gets the next request to be processed. The code shows how
the notifier: </p>
<ul>
<li><p>Gets an array of all waiting requests by calling <a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-4E117090-89E5-33DA-AC4B-494906B4BAF9"><span class="apiname">CPosPrivacyNotifier::GetRequestsL()</span></a>. </p>
</li>

<li><p>Gets the first request in the array and sets it as the current request
by calling <a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-A041F06C-8A22-37D3-B634-894AFE9B7FF0"><span class="apiname">CPosPrivacyNotifier::SetCurrentRequestL()</span></a>. </p>
</li>

<li><p>Checks if the request is a notification, and if so, checks if the request
type is supported by calling <a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-22FFC3B2-A6B9-3501-AD89-1DB31027F53C"><span class="apiname">CPosPrivacyNotifier::NotificationReason()</span></a>.
If the request type is not supported the request is completed by calling <a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-57739A9E-F6CD-3079-8B6F-9B80AAFE4D8B"><span class="apiname">CPosPrivacyNotifier::CompleteRequest()</span></a>. </p>
</li>

<li><p>Checks if the type of request is a privacy verification (<samp class="codeph">EQuery</samp>)
or a notification (<samp class="codeph">ENotification</samp>) and launches the appropriate
dialog for each case. </p>
<div class="note"><span class="notetitle">Note:</span> <samp class="codeph">LauchQueryDialog()</samp> and <samp class="codeph">LaunchNotificationDialog()</samp> show
the dialogs. Dialog code varies between licensee platforms but it is important
that these methods do not launch modal dialogs. The methods must return quickly
and not wait for the dialogs to be dismissed. </div>
</li>

</ul>
<pre class="codeblock">void CMyPrivacyNotifier::HandleNextRequestL()
    {
    // Read the next request
    RArray&lt;TPosQNRequestId&gt; requests;
    CleanupClosePushL(requests);
    GetRequestsL(requests);

    // Choose next request to handle
    TBool requestFound = EFalse;
    while (!requestFound)
        {
        if (requests.Count() == 0)
            { // There are no requests to handle. Do nothing.
            CleanupStack::PopAndDestroy(); // requests
            return;
            }
        // Read information about the active request
        iActiveRequest = requests[0];
        SetCurrentRequestL(iActiveRequest);

        // In case of notification request, check that notification reason is
        // supported, otherwise complete the request with KErrNotSupported.
        if (RequestTypeL(iActiveRequest) == ENotification &amp;&amp;
            !(NotificationReason() == EPosDecisionByRequestSource ||
            NotificationReason() == EPosVerificationTimeout))
            { // The notification reason is not supported by the UI.
            CompleteRequest(iActiveRequest, KErrNotSupported);
            requests.Remove(0);
            }
        else
            {
            requestFound = ETrue;
            }
        }
    CleanupStack::PopAndDestroy(); // requests

    iIsBusy = ETrue;

    CDesCArrayFlat* requestors = new (ELeave) CDesCArrayFlat
        (KRequestorGranularity);
    CleanupStack::PushL(requestors);
    
    TInt nofRequestors = RequestorCountL();
    for (TInt I = 0; I &lt; nofRequestors; I++)
        {
        CPosRequestor* requestor = RequestorLC(I);
        requestors-&gt;AppendL(requestor-&gt;RequestorIdString());
        CleanupStack::PopAndDestroy(requestor);
        }

    // Check whether the request is a query or a notification
    if (RequestTypeL(iActiveRequest) == EQuery)
        {
        LaunchQueryDialogL(requestors); // takes array ownership
        }
    else // RequestTypeL(iActiveRequest) == ENotification
        {
        LaunchNotificationDialogL(requestors); // takes array ownership
        }
    CleanupStack::Pop(requestors);
    }</pre>
</div>

<div class="section" id="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-6ACC09EA-DBCC-4AEE-B29A-B79B698D546E"><a name="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-6ACC09EA-DBCC-4AEE-B29A-B79B698D546E"><!-- --></a><h2 class="sectiontitle">Implementing a method to handle dialog closure</h2><p>When
the mobile device user has responded to the dialog, the notifier must send
a response back to the LBS subsystem. In the example code below, the method <samp class="codeph">DialogDismissed()</samp> is
called when the dialog is closed. The type of request (<samp class="codeph">EQuery</samp> or <samp class="codeph">ENotification</samp>)
and the reason why the dialog was closed is passed as an input parameter to
the method. </p>
<div class="note"><span class="notetitle">Note:</span> It is important to note that <a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-57739A9E-F6CD-3079-8B6F-9B80AAFE4D8B"><span class="apiname">CPosPrivacyNotifier::CompleteRequest()</span></a> must
be called for both privacy verification (query) requests and privacy notification
requests.</div>
<p>Note also how requests are handled sequentially in the
code: CPosPrivacyNotifier::HandleNextRequest() is called to process the next
request only when the current request is completed.</p>
<pre class="codeblock">void CMyPrivacyNotifier::DialogDismissed(TRequestType aRequestType, TInt aDismissReason)
    {

    iIsBusy = EFalse;

    // Complete the request with correct completion code.
    TInt completionCode = KErrNone;
    if (aRequestType == EQuery)
        {
        switch (aDismissReason)
            {
            case EUserChooseAccept : completionCode = KErrNone; break;
            case EUserChooseReject : completionCode = KErrAccessDenied; break;
            case EDialogTimedOut : completionCode = KErrTimedOut; break;
            default : completionCode = KErrGeneral;
            }
        }
    else // aRequestType == ENotification
        {
        switch (aDismissReason)
            {
            case EUserPressedOk : completionCode = KErrNone; break;
            case EDialogTimedOut : completionCode = KErrTimedOut; break;
            default : completionCode = KErrGeneral;
            }
        }
    CompleteRequest(iActiveRequest, completionCode);

    // Handle the next request
    HandleNextRequest();
    }

// Non leaving method for handling the next request
void CMyPrivacyNotifier::HandleNextRequest()
    {
    TRAPD(err, HandleNextRequestL());
    if (err)
        {
        CompleteAllRequests(err);
        }
    }</pre>
</div>

<div class="section" id="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-C954EB32-267E-494B-8715-92C9720ED830"><a name="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-C954EB32-267E-494B-8715-92C9720ED830"><!-- --></a><h2 class="sectiontitle">Implementing HandleRequestCancelled() </h2><p>A privacy
request can be cancelled by the network. The LBS subsystem calls <a href="GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C.html#GUID-56C8D5AB-7D9A-3B20-B699-07F17A87A61C__GUID-3417B07B-DE69-3719-8634-B979CBA77AFE"><span class="apiname">CPosPrivacyNotifier::HandleRequestCancelled()</span></a> on
the notifier to cancel the request. The code example below shows an implementation. </p>
<pre class="codeblock">void CMyPrivacyNotifier::HandleRequestCancelled(TPosQNRequestId aRequestId)
    {
    switch (CancelReason())
        {
        case EPosCancelReasonTimeout:
            // Notify the user that the query timed out.
            break;
        default: // Do nothing
            break;
        }

    // We only need to do anything if the request is the one which is currently
    // handled.
    if (iActiveRequest == aRequestId)
        {
        // Close the active dialog
        DismissDialog();
        HandleNextRequest();
        }
    }</pre>
</div>

<div class="section" id="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-42F9876A-9A93-48CB-8A19-489364A4A740"><a name="GUID-55629D12-06C9-412C-86FE-442577156A3B__GUID-42F9876A-9A93-48CB-8A19-489364A4A740"><!-- --></a><h2 class="sectiontitle">Implementing HandleAllRequestsCancelled()</h2><p>The notifier
must implement this method to allow all outstanding requests to be cancelled. </p>
<pre class="codeblock">void CMyPrivacyNotifier::HandleAllRequestCancelled()
    {
    // Close the active dialog
    DismissDialog();
    }</pre>
</div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-D4AB2D70-D49E-5F59-80F6-3D90F1D76BD5.html" title="This section gives guidance on how to create a Privacy Notifier using the Privacy Query and Notification API.">Using the Privacy Query and Notification API</a></div>
</div>
</div>
   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>