<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="Restrictions on the use of leaves and TRAPs in destructors"/>
<meta name="abstract" content="Outlines the restrictions on the use of leaves and TRAPs in destructors."/>
<meta name="description" content="Outlines the restrictions on the use of leaves and TRAPs in destructors."/>
<meta name="DC.Relation" scheme="URI" content="GUID-26D7BC6E-509C-51C5-9B86-437F3AEEB2EA.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-C14B2552-43A7-4499-ABFE-1725128DA6EF.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-0DF9E318-BE97-531E-AB39-A7B5E8787C87.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-A63025D1-7FD4-5120-8A1F-537D6B70103D.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-9636A30F-39EB-54E6-8125-4487D4002FE0.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-61DEE78D-4E78-5367-BC8A-F99D3B4E9D5A.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-26D7BC6E-509C-51C5-9B86-437F3AEEB2EA.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-F686965A-13E5-5C0A-AED1-55EC91C79433"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Restrictions on the use of leaves and TRAPs in destructors</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-F686965A-13E5-5C0A-AED1-55EC91C79433"><a name="GUID-F686965A-13E5-5C0A-AED1-55EC91C79433"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2387835 id2392072 id2392081 id2393700 id2393796 id2393804 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-C14B2552-43A7-4499-ABFE-1725128DA6EF.html" title="Kernel and Hardware Services performs the fundamental operating system tasks of managing access to device resources.">Kernel and Hardware Services Guide</a> &gt; <a href="GUID-0DF9E318-BE97-531E-AB39-A7B5E8787C87.html" title="Provides a framework for accessing file systems.">User Library and File Server</a> &gt; <a href="GUID-A63025D1-7FD4-5120-8A1F-537D6B70103D.html" title="The User Library allows the applications and services that run on a phone to access the functionality provided by the Symbian platform Kernel.">User Library</a> &gt; <a href="GUID-9636A30F-39EB-54E6-8125-4487D4002FE0.html" title="Memory is allocated to programs in chunks, the documentation in this set explains how to allocate, manage and release that memory.">Memory Management</a> &gt; <a href="GUID-61DEE78D-4E78-5367-BC8A-F99D3B4E9D5A.html" title="Provides an introduction to code construction and error management options.">More about Cleanup Support</a> &gt; <a href="GUID-26D7BC6E-509C-51C5-9B86-437F3AEEB2EA.html" title="Provides tutorials and an introduction to exception handling.">Exception Handling</a> &gt; </div>
<h1 class="topictitle1">Restrictions
on the use of leaves and TRAPs in destructors</h1>
<div><p>Outlines the restrictions on the use of leaves and TRAPs in destructors.</p>

<p>You <em>cannot</em> use <a href="GUID-3F2CDC74-2568-371C-9D8E-34A66A619226.html"><span class="apiname">TRAP</span></a> (and <a href="GUID-57895C34-AD00-35E1-9BF8-478653056383.html"><span class="apiname">TRAPD</span></a>)
and <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-ABF0FC5C-3334-3761-893D-D836B2EE0541"><span class="apiname">User::Leave()</span></a> in a destructor, nor in any function
that a destructor might call, for objects that have been placed onto the call
stack. <a href="GUID-3F2CDC74-2568-371C-9D8E-34A66A619226.html"><span class="apiname">TRAP</span></a> and <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-ABF0FC5C-3334-3761-893D-D836B2EE0541"><span class="apiname">User::Leave()</span></a> are implemented
in terms of C++ Try, Catch and Throw. This means that if an exception occurs,
the call stack is "unwound". In doing this, the destructors of objects on
the call stack are called. If any of these destructors subsequently throw
an exception, this is termed a nested exception. While a nested exception
is supported on the emulator (WINS), it is not supported on other hardware,
and there is no guarantee that the thread will terminate cleanly. </p>

<p>Symbian coding standards state that objects placed onto the call stack
should not have non-trivial destructors. By convention, such classes are identified
by names having an initial T or R. This means that such destructors should
not leave. </p>

<p>The following code fragment shows the kind of code that is <em>not safe</em> to
use: </p>

<pre class="codeblock" id="GUID-F686965A-13E5-5C0A-AED1-55EC91C79433__GUID-7B2BD496-6F99-5586-B320-DB7C5DC490B9"><a name="GUID-F686965A-13E5-5C0A-AED1-55EC91C79433__GUID-7B2BD496-6F99-5586-B320-DB7C5DC490B9"><!-- --></a>void f()  
    {
    TBar bar;
    // Function processing.
    ...
    // The bar object on the call stack is automatically destroyed
    // at function termination.
    }

TBar::~TBar()
    {
    // The destructor calls a function that can leave.
    // This is not permitted here.
    doCleanUpL();
    }</pre>

<p>You <em>can</em> use <a href="GUID-3F2CDC74-2568-371C-9D8E-34A66A619226.html"><span class="apiname">TRAP</span></a> (and <a href="GUID-57895C34-AD00-35E1-9BF8-478653056383.html"><span class="apiname">TRAPD</span></a>)
and <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html#GUID-C197C9A7-EA05-3F24-9854-542E984C612D__GUID-ABF0FC5C-3334-3761-893D-D836B2EE0541"><span class="apiname">User::Leave()</span></a> in a destructor and in any function that
a destructor might call, for heap-based objects, i.e. objects that are destroyed
by the cleanup stack. However, while this is permissible, it is not recommended
practice. </p>

<p>Such objects are instances of classes derived from <a href="GUID-8F6FE089-E2A8-30F4-B67E-10F286347681.html"><span class="apiname">CBase</span></a>,
and by convention such classes are identified by names having have an initial
C. </p>

<p>In principle, a destructor should never fail. If a destructor can leave,
or a function called by the destructor can leave, it suggests that the code
has been poorly architected. It also implies that part of the destruction
process might fail, potentially leading to memory or handle leaks. </p>

<p>One possible approach to avoid using functions that can leave within a
destructor is to have what might be referred to as ‘two-phase destruction’
where some form of <samp class="codeph">ShutdownL</samp> function is called prior to
deleting the object. If there are concerns about introducing additional complexities
in API-usage (and greater risk), suitable guards can be introduced. One method
might be to store the current state of the object internally and then use
an ASSERT to check this in the destructor. This would ensure that any usage
errors are discovered by very simple run time testing. </p>

<p>The following code fragment shows an example of two-phase destruction. </p>

<pre class="codeblock" id="GUID-F686965A-13E5-5C0A-AED1-55EC91C79433__GUID-BA3B57D6-913F-5AEC-A7AB-4EE6B915127A"><a name="GUID-F686965A-13E5-5C0A-AED1-55EC91C79433__GUID-BA3B57D6-913F-5AEC-A7AB-4EE6B915127A"><!-- --></a>// Here, the shutdown function is a member of the class CMyClass,
// and performs destruction activity that can leave.

class CMyClass : public CBase
    {
public :
    IMPORT_C ~CMyClass();
    IMPORT_C void ShutdownL();
    ...
private :
    TBool iStateActive
    ...
    }

EXPORT_C void CMyClass::ShutdownL()
    {
       if (iStateActive == ETrue)
              {
              // Some destruction activity that can leave.
              iStateActive = EFalse;
              }
    }

EXPORT_C CMyClass::~CMyClass()
    {
       // Assert to ensure that ShutdownL() has already been called.
       ASSERT(iStateActive == EFalse);
    }
</pre>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-26D7BC6E-509C-51C5-9B86-437F3AEEB2EA.html" title="Provides tutorials and an introduction to exception handling.">Exception Handling</a></div>
</div>
</div>
   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>