<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="SIP Example: Usage of the SIP Stack"/>
<meta name="DC.Relation" scheme="URI" content="GUID-057F1F82-56AF-5696-853E-79196A3D567E.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-6425B722-4095-56E3-9198-70BA3E06C617.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-057F1F82-56AF-5696-853E-79196A3D567E.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>SIP Example: Usage of the SIP Stack</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2397554 id2397680 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-6425B722-4095-56E3-9198-70BA3E06C617.html">Multimedia Protocols Guide</a> &gt; <a href="GUID-057F1F82-56AF-5696-853E-79196A3D567E.html">SIP</a> &gt; </div>
<h1 class="topictitle1">SIP
Example: Usage of the SIP Stack</h1>
<div>
<p>The SIP sample application is a game that can be played between two users
that use two different machines. The following figure illustrates the sample
application. </p>

<div class="fignone" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-A0E243BE-E697-5856-8C08-6039AAE6A05A"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-A0E243BE-E697-5856-8C08-6039AAE6A05A"><!-- --></a>
<img src="GUID-155C5B39-CB9B-5405-B9BB-EB34CA7C43BC_d0e559276_href.png"/>
</div>

<p>All users who want to play the game must register to the server with their
identities. This informs the server that the user is active and prepared to
participate in the game. If User 1 wants to play the game with User 2 then
it must send a request to User 2 through the server. When User 2 accepts the
request and acknowledges it then the two users can start playing. A user can
disconnect from playing the game by sending a message. If a user wants to
be deactivated then it can deregister from the server. </p>

<p>This application is developed using the key features of the Symbian SIP
stack. It shows how to create profiles and do SIP registration using the profiles,
how to set up a SIP session and send an instant message using the SIP. For
example you can set up the SIP server using Brekeke and you can download the
same from <a href="http://www.brekeke.com/download/download_sip_2_0.php" target="_blank">http://www.brekeke.com/download/download_sip_2_0.php</a>. </p>

<div class="section"><h2 class="sectiontitle">Features of the game</h2> <p>The main features of the game
are: </p>
 <ul>
<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-8767E5EC-04F6-5D19-B77A-94C6E7BF10B7"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-8767E5EC-04F6-5D19-B77A-94C6E7BF10B7"><!-- --></a><p> <strong>Register or deregister </strong> -
A user registers to the server with a unique identity before playing the game.
This identity is the SIP URI of the user. The user registers by sending a
SIP REGISTER message to the SIP server and is active. A user deactivates by
deregistering to the server. This activity is done by sending the SIP REGISTER
message with the expires header set to 0. For more information on registering
or deregistering to the server see, <a href="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F.html#GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-2C4A1BCE-CD8E-5BDC-84D1-2C5DDBF8A142">Registering
or deregistering an user</a>. </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-1547D0C9-4B7C-568F-9C5D-A2BE20F9B362"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-1547D0C9-4B7C-568F-9C5D-A2BE20F9B362"><!-- --></a><p> <strong>Invite another user</strong> -
A user invites another user to play the game by entering the SIP URI of the
other user in the INVITE message. For more information on inviting another
user to play the game see, <a href="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F.html#GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-7D5CB45C-614B-58DF-8EE4-1AB2DB02CE1C">Inviting
a participant for session setup</a>. </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-94802B8B-C10B-5ADB-A5E0-0FC436790427"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-94802B8B-C10B-5ADB-A5E0-0FC436790427"><!-- --></a><p> <strong>Send a message to
another user</strong> - A user can send an instant message to another user. For
more information on how to send an instant message to another user see, <a href="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F.html#GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-0E7C6F87-C90B-5888-B1F7-33ED0D7393F5">Sending
an instant message</a>. </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-55484DA7-37DC-566B-95F8-066E19AA5790"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-55484DA7-37DC-566B-95F8-066E19AA5790"><!-- --></a><p> <strong>Disconnect from
playing the game</strong> - A user can disconnect from playing the game by sending
a SIP BYE message to the other user. </p>
 </li>

</ul>
 </div>

<div class="section" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-3A9BE5C5-A9A2-54A8-B525-6750E562EF97"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-3A9BE5C5-A9A2-54A8-B525-6750E562EF97"><!-- --></a><h2 class="sectiontitle">How to play
the game</h2> <p>The following snapshot shows the different tabs available
in the game. </p>
 <div class="fignone" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-15C8B95B-4B8C-5701-80B1-C0D7B39AF422"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-15C8B95B-4B8C-5701-80B1-C0D7B39AF422"><!-- --></a>
<img src="GUID-0E21EAE4-BF71-55FD-9561-EA5530696627_d0e559349_href.png"/>
</div>
 <p>The following list describes the different tabs available in the
game: </p>
 <ul>
<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-CDB3E759-F01D-5D02-B8AA-7E901C1984BE"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-CDB3E759-F01D-5D02-B8AA-7E901C1984BE"><!-- --></a><p> <strong>Invite for game</strong> -
This tab allows you to invite a user to play the game. When you invoke this
tab, a UI screen appears which asks the user to provide the SIP URI of the
second user with whom the user wants to play the game. The SIP URI of the
second user is then sent to the SIP stack which passes on the invite request
to the second user. The second user can accept or reject the invite. If the
second user accepts the invite then it acknowledges by sending a message that
it is prepared to start playing the game. If the second user rejects the invite
then it cannot play the game. </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-4A4F6318-1FDD-540A-BF87-72B19BE56A97"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-4A4F6318-1FDD-540A-BF87-72B19BE56A97"><!-- --></a><p> <strong>Enable profile</strong> -
This tab allows you to enable a profile. When you invoke this tab, a UI screen
appears where the user enters the values. A profile is created using these
values and the user registers with the SIP server. </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-A9F95A0B-4E44-52C6-AD0B-E2BDFA4C8CCE"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-A9F95A0B-4E44-52C6-AD0B-E2BDFA4C8CCE"><!-- --></a><p> <strong>Send instant msg</strong> -
This tab allows you to send a message to another user. When you invoke this
tab, a message with the address of the recipient is sent to the SIP stack.
The SIP stack sends this message to the recipient address. </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-4334DC63-8AAB-581C-A779-FBBBD44C4227"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-4334DC63-8AAB-581C-A779-FBBBD44C4227"><!-- --></a><p> <strong>End game</strong> - This
tab allows you to disconnect from playing the game. When you invoke this tab,
a BYE message is sent to the other user and the game is terminated. </p>
 </li>

</ul>
 </div>

<div class="section" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-2C4A1BCE-CD8E-5BDC-84D1-2C5DDBF8A142"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-2C4A1BCE-CD8E-5BDC-84D1-2C5DDBF8A142"><!-- --></a><h2 class="sectiontitle">Registering
or deregistering an user</h2> <p>An application can register to the SIP
Server using: </p>
 <ul>
<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-620D3765-E3A1-55B9-900F-562486A01D6B"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-620D3765-E3A1-55B9-900F-562486A01D6B"><!-- --></a><p>the <a href="GUID-48AA01D5-CE7B-3C22-B2E0-529261121EC4.html"><span class="apiname">CSIPRegistrationBinding</span></a> class
and its methods </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-DDC990A1-BFDC-5CA4-A392-EAADFB8C3921"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-DDC990A1-BFDC-5CA4-A392-EAADFB8C3921"><!-- --></a><p>the SIP Profile Agent </p>
 </li>

</ul>
 <p>This sample application uses the SIP Profile Agent method to do SIP
registration. To use this method you need a SIP profile setting, and you must
create a SIP profile before you start using the application. <strong>Note</strong>:
A list of SIP profile settings can be found in the <a href="GUID-68AE6070-0410-3671-9E68-A7785B8271CD.html"><span class="apiname">CSIPProfile</span></a> class. </p>
 <p>The
SIP profile agent method provides APIs for: </p>
 <ul>
<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-68A120EA-45B6-5909-8DD1-B125A1249C13"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-68A120EA-45B6-5909-8DD1-B125A1249C13"><!-- --></a><p>Registering and Deregistering </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-50AA5E67-EA40-5844-873B-77DAAE94480F"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-50AA5E67-EA40-5844-873B-77DAAE94480F"><!-- --></a><p>Listening to registration
events </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-300245B5-2B62-5382-B492-8BE8759E48E3"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-300245B5-2B62-5382-B492-8BE8759E48E3"><!-- --></a><p>Creating, modifying,
and deleting the SIP profile settings that the profile agent plug-in implementations
use for SIP registration. </p>
 </li>

</ul>
 <p>The following code from <span class="filepath">SIPExProfileQueryDlg.cpp</span> shows
how the sample application stores the settings entered by users on the SIP
profile store. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-8D76FE52-F0E5-5F57-AD38-0AE8694D3AA4"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-8D76FE52-F0E5-5F57-AD38-0AE8694D3AA4"><!-- --></a>//Create a new profile
    CSIPManagedProfile* profile = iMProfileRegistry-&gt;CreateL(iProfileData.iServiceProfile);
   
//Copy attributes entered by the user to the new profile        
    iNewProfile = profile;
    profile = CopyDataToProfileL();

//Set the profile to default and save some settings
    TInt err= profile-&gt;SetParameter(KSIPDefaultProfile,ETrue);
   
//Save the profile to persistent store                
    iMProfileRegistry-&gt;SaveL( *profile );
</pre>
 <p>The applications can start SIP registration or deregistration
using the <samp class="codeph">Enable</samp> or <samp class="codeph">Disable</samp> methods from
the SIP profile API. </p>
 <p>The following code from <span class="filepath">SIPExSIPEngine.cpp</span> shows
how to register using the profile agent. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-F4398335-6AC0-5E10-B04D-6846A3CDE1D5"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-F4398335-6AC0-5E10-B04D-6846A3CDE1D5"><!-- --></a>//Check for the existing profile
    if ( iProfile )
        {
        delete iProfile;
        iProfile = NULL;
        }
    TBool registered( EFalse );
    
//Leaves with KErrNotFound if default profile is not found
    iProfile = iProfileRegistry-&gt;DefaultProfileL();
 else
        {
        const TDesC8* aor = NULL;
  iProfile-&gt;GetParameter( KSIPUserAor, aor );      
  iProfileRegistry-&gt;EnableL( *iProfile, *this );

    //Check if the profile was immediately set to the registered state
    iProfile-&gt;GetParameter( KSIPProfileRegistered, registered );
        }
</pre>
 <p>The following code from <span class="filepath">SIPExSIPEngine.cpp</span> shows
how to deregister using the profile agent. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-B13F8581-D36B-5AE1-A821-84FD3B010575"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-B13F8581-D36B-5AE1-A821-84FD3B010575"><!-- --></a>if ( iProfile )
        {
        iProfileRegistry-&gt;Disable( *iProfile );
        delete iProfile;
        iProfile = NULL;        
        }</pre>
 <p>The SIP profile API also provides a notification
method that is used by an application to monitor profile related events. </p>
 <p>The
following code from <span class="filepath">SIPExProfileQueryDlg.cpp</span> shows the
profile related events that the sample applications monitors. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-34230A3A-EA20-56B9-AFC0-F9AC92BE2F3E"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-34230A3A-EA20-56B9-AFC0-F9AC92BE2F3E"><!-- --></a>void ProfileRegistryEventOccurred( 
    TUint32 aProfileId, 
    TEvent aEvent )
    {
    switch (aEvent)
        {
        case MSIPProfileRegistryObserver::EProfileRegistered:
            {
            HandleProfileRegistered( aProfileId );
            break;
            }
        case MSIPProfileRegistryObserver::EProfileDeregistered:
            {
            HandleProfileDeregistered( aProfileId );
            break;
            }
        case MSIPProfileRegistryObserver::EProfileDestroyed:
            {
            HandleProfileDestroyed( aProfileId );
            break;
            }
        default:
            {
            // MSIPProfileRegistryObserver::EProfileCreated and MSIPProfileRegistryObserver::EProfileUpdated are ignored
            break;
            }
        }
    }
void ProfileRegistryErrorOccurred( 
    TUint32 /* aSIPProfileId */,
    TInt aError )
    {
    iObserver-&gt;ProfileError( aError );
    }
</pre>
 <p><strong>Classes containing APIs in scope</strong> </p>
 <p> <a href="GUID-68AE6070-0410-3671-9E68-A7785B8271CD.html"><span class="apiname">CSIPProfile</span></a>, <a href="GUID-CDE67614-1A7A-3082-8D8D-71645668A0DE.html"><span class="apiname">CSIPManagedProfile</span></a>, <a href="GUID-E8D080AD-4494-3880-B5CE-3487CA7D76E9.html"><span class="apiname">CSIPProfileRegistry</span></a>, <a href="GUID-5266AB0D-705C-3011-A92B-DA82BC212999.html"><span class="apiname">CSIPManagedProfileRegistry</span></a>, <a href="GUID-91663686-42B7-3C88-B773-3C5343CDCFCE.html"><span class="apiname">MSIPProfileRegistryObserver</span></a>. </p>
 </div>

<div class="section" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-7D5CB45C-614B-58DF-8EE4-1AB2DB02CE1C"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-7D5CB45C-614B-58DF-8EE4-1AB2DB02CE1C"><!-- --></a><h2 class="sectiontitle">Inviting a
participant for session setup</h2> <p>The sample application uses the SIP
INVITE method to setup a session between two users. In this case, the application
does not accept any SDP parameters from the user and instead sends fixed SDP
values. </p>
 <p>The following code from <span class="filepath">SIPExSIPIdleState.cpp</span> shows
how the application sends an INVITE message. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-B8E774F0-D6C0-5631-83E3-5D87DF03D044"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-B8E774F0-D6C0-5631-83E3-5D87DF03D044"><!-- --></a>void SendInviteL( 
    CSIPExSIPEngine&amp; aEngine,
    const TDesC8&amp; aSipUri )
    {
    //Retrieve the active profile and connection
    CSIPProfile&amp; prof = aEngine.Profile();
    CSIPConnection&amp; conn = aEngine.ConnectionL();

 //Create CUri8 from the passed descriptor. This value is given by the user
    CUri8* uri8 = aEngine.ConvertToUri8LC( aSipUri );
    
    //Get dialog association, save for future use
    //The ownership of uri8 is transferred
    CSIPInviteDialogAssoc* dialogAssoc =
        CSIPInviteDialogAssoc::NewL( conn, uri8, prof );
        aEngine.SetDialogAssoc( *dialogAssoc ); //Ownership is transferred!!

    //Create the necessary message elements
    CSIPMessageElements* msgElements = aEngine.CreateMessageElementsLC();

    //Send the INVITE in the dialog
    //The ownership of msgElements is transferred
    INVITE SENT OUT
    CSIPClientTransaction* tx = dialogAssoc-&gt;SendInviteL( msgElements );
 }
</pre>
 </div>

<div class="section" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-BADF4C98-FB28-50F1-AC00-F8764CBF2B12"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-BADF4C98-FB28-50F1-AC00-F8764CBF2B12"><!-- --></a><h2 class="sectiontitle">Handling an
incoming invite</h2> <p>An application that wants to receive an incoming
invite outside the dialog must implement the Client Resolver API. The <a href="GUID-14EC2BB8-AE94-3052-8A0B-039BA6E9C610.html"><span class="apiname">CSipResolvedClient</span></a> (<span class="filepath">SipResolvedClient.h</span>) interface is implemented by clients to enable a client resolution mechanism
when the SIP requests are received outside the SIP dialog. The application
must state the capabilities, that is the supported content types and media
formats. This is done using the SIP headers and SDP m-lines either in the
code of the plug-in, that is in <samp class="codeph">const KCapabilities</samp> or in
the opaque_data field of the resource file. </p>
 <p>The capabilities can be
provided to the plug-ins in two ways: </p>
 <ul>
<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-04021FC9-D7F1-592E-A286-3E3C905880EB"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-04021FC9-D7F1-592E-A286-3E3C905880EB"><!-- --></a><p>The data is provided
in the ECOM resource file. </p>
 </li>

<li id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-ABBC862D-2930-5268-9FE9-2D8C7CA6C656"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-ABBC862D-2930-5268-9FE9-2D8C7CA6C656"><!-- --></a><p>In the interface implementation
from where it is used to determine the target client. </p>
 </li>

</ul>
 <p>The following code from <span class="filepath">SIPExResolverPlugin.cpp</span> shows
how the data is provided in the ECOM resource file. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-18FE5466-1BA2-57FD-BD3D-5818AFC35767"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-18FE5466-1BA2-57FD-BD3D-5818AFC35767"><!-- --></a>#include &lt;RegistryInfo.rh&gt;
RESOURCE REGISTRY_INFO theInfo
    {
    // UID for the DLL
    dll_uid = 0xA00001EC;
    // Declare array of interface info
    interfaces = 
        {
        INTERFACE_INFO 
            {
            // UID of interface that is implemented
            interface_uid = 0x102010DD;
            implementations = 
                {
                IMPLEMENTATION_INFO
                    {
                    implementation_uid = 0xA00001EC;
                    version_no = 1;
                    // SIPEx UID: Must match to the one SIPEx passes to CSIP::NewL.    
                    default_data = "A00001EB";
                    }
                };
            }
        };
    }</pre>
 <p>The following code from <span class="filepath">SIPExResolverPlugin.cpp</span> shows
how the capabilities are defined in the plug-in. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-5D448F3C-CA4E-5EB2-9416-9383DC08A182"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-5D448F3C-CA4E-5EB2-9416-9383DC08A182"><!-- --></a>//Code for defining capabilities in plugin
//File : SIPExResolverPlugin.cpp

_LIT8(KCapabilities,
"&lt;SIP_CLIENT ALLOW_STARTING=\"YES\"&gt;\
&lt;SIP_HEADERS&gt;\
&lt;ACCEPT value=\"application/sdp\"/&gt;\
&lt;ACCEPT value=\"SIPEx/InstantMessage\"/&gt;\
&lt;/SIP_HEADERS&gt;\
&lt;SDP_LINES&gt;\
&lt;LINE name=\"m\" value=\"application 0 TCP SIPEx\"/&gt;\
&lt;/SDP_LINES&gt;\
&lt;/SIP_CLIENT&gt;");


</pre>
 <p>When there is an incoming <samp class="codeph">Invite Request</samp> with
SDP parameters the SIP stack passes the request to the Client Resolver to
get the resolved client for that request. The Client Resolver gets the capabilities
for all the applications that implement the Client Resolver API. </p>
 <p>The
following code from <span class="filepath">SIPExResolverPlugin.cpp</span> shows how
to get the capabilities for an application. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-819B95EE-5D9E-5BF6-BE49-1E00C3144CB8"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-819B95EE-5D9E-5BF6-BE49-1E00C3144CB8"><!-- --></a>//Code for obtaining capabilities for an application
//File : SIPExResolverPlugin.cpp

const TDesC8&amp; CSIPExResolverPlugin::Capabilities()
    {
    return KCapabilities;
    }</pre>
 <p>When the target client is identified, the Client Resolver
gets the ChannelID from the plug-in implementation and requests the resolved
client to connect to the SIP implementation on that UID. <strong>Note</strong>: The
ChannelID is same as Application UID3 </p>
 <p>The following code from <span class="filepath">SIPExResolverPlugin.cpp</span> shows
how to get ChannelID for an application. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-3516BAD9-E116-59AA-9424-AEA7FB0DDADA"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-3516BAD9-E116-59AA-9424-AEA7FB0DDADA"><!-- --></a>//Code for obtaining ChannelID for an application
//File : SIPExResolverPlugin.cpp
  
  TUid CSIPExResolverPlugin::ChannelL( RStringF /*aMethod*/,
    const TDesC8&amp; /*aRequestUri*/,
    const RPointerArray&lt;CSIPHeaderBase&gt;&amp; /*aHeaders*/,
    const TDesC8&amp; /*aContent*/,
    const CSIPContentTypeHeader* /*aContentType*/)
    {
    return iApplicationUID;
    }

//Code for asking an application to connect on UID 
//File : SIPExResolverPlugin.cpp

 void CSIPExResolverPlugin::ConnectL( TUid aUid )
    {
    //Launch application is based on UID passed from the SIP stack
    
    TApaAppInfo appInfo;
    User::LeaveIfError( iApaSession.GetAppInfo( appInfo, aUid ) );
    CApaCommandLine* cmdLine = CApaCommandLine::NewLC();
#ifdef EKA2
    cmdLine-&gt;SetExecutableNameL( appInfo.iFullName );
#else
    cmdLine-&gt;SetLibraryNameL( appInfo.iFullName );
#endif
    User::LeaveIfError( iApaSession.StartApp( *cmdLine ) );
    CleanupStack::PopAndDestroy( cmdLine ); 
    }</pre>
 <p>When the resolved client connects, the INVITE is forwarded
to the client and it starts ringing (180 Ringing) and sends the provisional
response to the calling party. This part is implemented in <a href="GUID-D891F857-2AE0-3112-8A9D-8648F98F96AC.html"><span class="apiname">InviteReceivedL</span></a> as
shown in the following code. </p>
 <p>The following code from <span class="filepath">SIPExSIPIdleState.cpp</span> shows
how the application gets the INVITE and how the provisional response is sent. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-7775ADCE-4351-5D50-BD91-85C0FEBF47E5"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-7775ADCE-4351-5D50-BD91-85C0FEBF47E5"><!-- --></a>/Code for CSIPExSIPIdleState::InviteReceivedL()... 
//File : SIPExSIPIdleState.cpp    

void CSIPExSIPIdleState::InviteReceivedL( 
    CSIPExSIPEngine&amp; aEngine,
    CSIPServerTransaction* aTransaction )
    {
    _LIT8( KLogEntry, "180 Ringing sent" );
    ..
    ..
    aEngine.Observer()-&gt;WriteLog( KLogEntry );
    ..
   }</pre>
 <p>From this stage, the INVITE is sent to <samp class="codeph">InviteReceived</samp> of <samp class="codeph">CSIPExEngine</samp> in <span class="filepath">SIPExGameEngine.cpp</span> from where it asks from the game observer if the user has accepted the invitation
or not. The game starts or does not start depends on action taken. </p>
 <p>The
following code from <span class="filepath">SIPExStateRegistered.cpp</span> shows how
the acceptance is asked from the game observer. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-224959DA-DF2D-5969-85E1-2B71DC32C176"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-224959DA-DF2D-5969-85E1-2B71DC32C176"><!-- --></a>//The acceptance is asked from the user and if accepted the game is reset, start
//listening socket and signal the SIP engine to send Accepted to the remote peer.

//File : SIPExStateRegistered.cpp

void TSIPExStateRegistered::InviteReceived( 
    CSIPExEngine* aContext, 
    const TDesC8&amp; aFrom, 
    const TUint32 aIapId )
    {
    iEnded = EFalse;
    
    TBool retVal( EFalse );
    TRAPD( ignore, retVal = aContext-&gt;AcceptInvitationL( aFrom ) );
    if ( iEnded )
        {
        return;
        }
    if( retVal )
        {
        StatusInfo( aContext, KGameStarting() );
        ChangeState( aContext, aContext-&gt;iStateAcceptingSIP );
        aContext-&gt;ResetGame();
        aContext-&gt;SetPeer( CSIPExEngine::EServer );
        Info( aContext, KListening() );
        TInetAddr addr;
        TRAP( ignore, addr = 
                        aContext-&gt;SocketEngineL()-&gt;StartListeningL( aIapId ) );
        Info( aContext, KAccepting() );
        TRAP( ignore, aContext-&gt;SIPEngine()-&gt;AcceptInviteL( addr ) );
        Info( aContext, KWaitingRemoteConn() );
        }
    else 
        {
        TRAP( ignore, aContext-&gt;SIPEngine()-&gt;DeclineInviteL() );
        Info( aContext, KInviteDeclined() );
        }
    }
</pre>
 <p>When the game observer accepts the invitation the following
code from <span class="filepath">SIPExGameEngine.cpp</span> is run. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-91EF56AD-266F-5EE8-B8C0-37C1A6529C48"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-91EF56AD-266F-5EE8-B8C0-37C1A6529C48"><!-- --></a>//File : SIPExGameEngine.cpp

TBool CSIPExEngine::AcceptInvitationL( const TDesC8&amp; aFrom )
    {
    HBufC* from = HBufC::NewLC( aFrom.Length() );
    from-&gt;Des().Copy( aFrom );
    TBool retVal = iGameObserver.AcceptInvitationL( *from );
    CleanupStack::PopAndDestroy( from );
    return retVal;
    }</pre>
 </div>

<div class="section" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-0E7C6F87-C90B-5888-B1F7-33ED0D7393F5"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-0E7C6F87-C90B-5888-B1F7-33ED0D7393F5"><!-- --></a><h2 class="sectiontitle">Sending an
instant message</h2> <p>This sample application allows a user to send an
Instant Message (IM) to another user. The user requires SIP URI of the other
user and the message content that the user must enter. The application then
creates a MESSAGE (request message) with these parameters and uses <a href="GUID-D8168DEA-50CC-342B-AEF1-4703B50794A6.html"><span class="apiname">SendRequestL()</span></a> to
send it. </p>
 <p>The following code from <span class="filepath">SIPExSIPEngine.cpp</span> shows
how to send an instant message. </p>
 <pre class="codeblock" id="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-641C6039-11B4-5389-8876-D817D5541CCE"><a name="GUID-CF17532E-5E90-5124-8F05-AA72B848F17F__GUID-641C6039-11B4-5389-8876-D817D5541CCE"><!-- --></a>//Create and send an instant message to a recipient defined with the parameters.
//This is implemented with the MESSAGE method and is sent outside of a dialog.

CreateIML(const TDesC8&amp; aMessage,
    const TDesC8&amp; aSipUri )
    {
    _LIT8( KMediaType, "SIPEx" );    // Part of content type
    _LIT8( KMediaSubType, "InstantMessage" );    // Part of content type

//Create the necessary elements of the IM
    
CSIPRequestElements* reqElem = CreateReqElementsLC( aSipUri );
    CSIPToHeader* toHeader = CreateToHeaderLC( aSipUri );
    reqElem-&gt;SetToHeaderL( toHeader );
    
//Create the fromHeader value using the information from the profile

 const TDesC8* aor = NULL;
 iProfile-&gt;GetParameter( KSIPUserAor, aor ); 
 CSIPAddress* addr = CSIPAddress::DecodeL( *aor );
 CSIPFromHeader* fromHeader = CSIPFromHeader::NewL( addr );
 reqElem-&gt;SetFromHeaderL( fromHeader );
 reqElem-&gt;SetMethodL( SIPStrings::StringF( SipStrConsts::EMessage ) );

//Get reference to the message elements from the request elements, create and insert content type header (ownership of the content type object is transferred)

    CSIPMessageElements&amp; msgElem = reqElem-&gt;MessageElements();
    CSIPContentTypeHeader* ct =    CSIPContentTypeHeader::NewLC( KMediaType, KMediaSubType );
    msgElem.SetContentL( aMessage.AllocL(), ct );
    
//Get the current connection

CSIPConnection&amp; conn = ConnectionL();

//Send the request using the connection (ownership of the request elements object is transferred)

    CSIPClientTransaction* ctx = conn.SendRequestL( reqElem );
    delete ctx;
    }

</pre>
 <p><strong>Classes containing APIs in scope</strong> </p>
 <p> <a href="GUID-19FB031A-CFA7-3C67-A627-CFF501060AA5.html"><span class="apiname">CSIPRequestElements</span></a>, <a href="GUID-7B5D0432-5C2C-3EFB-B9FA-8B4A0AA68FC0.html"><span class="apiname">CSIPToHeader</span></a>, <a href="GUID-AFEC85BE-5971-3043-B9A9-24048346AADE.html"><span class="apiname">CSIPFromHeader</span></a>, <a href="GUID-F8BF1190-F5D4-31EF-B060-A1430AA07DAC.html"><span class="apiname">CSIPAddress</span></a>, <a href="GUID-77CFD812-7238-3B84-80FF-475BD73C3506.html"><span class="apiname">CSIPMessageElements</span></a>, <a href="GUID-059F9C3A-EA04-3295-912F-50444F073CE7.html"><span class="apiname">CSIPClientTransaction</span></a>. </p>
 </div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-057F1F82-56AF-5696-853E-79196A3D567E.html">SIP</a></div>
</div>
</div>
   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>