<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="State Machines"/>
<meta name="abstract" content="Description of the structure and operation of state machines."/>
<meta name="description" content="Description of the structure and operation of state machines."/>
<meta name="DC.Relation" scheme="URI" content="GUID-C6825C8F-8020-58CF-A09E-34558B1542DE.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-C14B2552-43A7-4499-ABFE-1725128DA6EF.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-CFD2236E-7775-5532-89CD-7D0E1E219FD8.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-2F114BC9-9B5D-5989-9CF3-37A43377DC58.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-79B2CF91-FB95-5E7C-81CC-235A6A660D88.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-9573F7B9-76E9-5DCB-A498-C0DE59606911.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-C6825C8F-8020-58CF-A09E-34558B1542DE.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>State Machines</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2387835 id2400576 id2400607 id2400622 id2400630 id2400650 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-C14B2552-43A7-4499-ABFE-1725128DA6EF.html" title="Kernel and Hardware Services performs the fundamental operating system tasks of managing access to device resources.">Kernel and Hardware Services Guide</a> &gt; <a href="GUID-CFD2236E-7775-5532-89CD-7D0E1E219FD8.html" title="Provides an overview of generic driver support.">Generic Driver Support</a> &gt; <a href="GUID-2F114BC9-9B5D-5989-9CF3-37A43377DC58.html" title="Provides the physical device drivers, called media drivers, and associated libraries that manage storage media hardware.">Media Drivers</a> &gt; <a href="GUID-79B2CF91-FB95-5E7C-81CC-235A6A660D88.html" title="The MMC Controller provides kernel extensions that manages access to the MultiMediaCard hardware on behalf of media drivers or any other device driver.">MMC Controller</a> &gt; <a href="GUID-9573F7B9-76E9-5DCB-A498-C0DE59606911.html" title="Describes the technology, architecture, and behaviour of the MMC Controller.">Concepts</a> &gt; <a href="GUID-C6825C8F-8020-58CF-A09E-34558B1542DE.html" title="This section describes the detailed structure and operation of the MMC Controller.">MMC Controller Operation</a> &gt; </div>
<h1 class="topictitle1">State
Machines</h1>
<div><p>Description of the structure and operation of state machines.</p>

<p>The MultiMediaCard Controller uses state machines to manage the interactions
with the MultiMediaCard hardware. </p>

<p>State machines allows the controller to maintain the state of each submitted
session – allowing it to schedule a second session when the first becomes
blocked, for example. </p>

<p>To handle the complex sequence of bus operations involved, the controller
implements a state machine stack, allowing a parent state machine function
to invoke a child state machine function. The state machine stack allows nesting
of children down to a depth of 10 levels. </p>

<p>Each session object has its own individual state machine stack because
each session runs its own sequence of bus operations, with the controller
managing these multiple sequences. This means that each session object has
a state machine object, an instance of the <a href="GUID-022AC0FE-86EE-3908-A9F8-4A33D04A68A5.html"><span class="apiname">TMMCStateMachine</span></a> class. </p>

<div class="fignone" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-3CD3F1EF-FB6A-5D5D-B806-75536F8DF533"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-3CD3F1EF-FB6A-5D5D-B806-75536F8DF533"><!-- --></a>
<img src="GUID-4592D493-A47C-5622-8C03-F24FABB4381C_d0e397658_href.png"/>
</div>

<p>The state machine remembers the next state and child function name, and
moves to that state as soon as control returns to the session. </p>

<p>The stack chooses the next session to be handled and manages the state
machine through the state machine dispatcher. </p>

<ul>
<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-76BEBC23-FC9D-5244-A3EA-2A5424FC02D7"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-76BEBC23-FC9D-5244-A3EA-2A5424FC02D7"><!-- --></a><p> <a href="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7.html#GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-44473E52-82B4-55E7-AE85-15AC88CE5BEB">Structure of the state machine stack</a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-0A56A8B9-65D7-54CB-A584-8C3C9AEFE339"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-0A56A8B9-65D7-54CB-A584-8C3C9AEFE339"><!-- --></a><p> <a href="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7.html#GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-E8FCFD65-4664-52EE-B658-FCABF50D501D">Structure of a state machine function</a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-85E36E04-60CD-5560-93DE-5C15E8DBDD45"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-85E36E04-60CD-5560-93DE-5C15E8DBDD45"><!-- --></a><p> <a href="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7.html#GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-667C5A70-0ABB-525F-A309-58102E380400">Example of a state machine calling sequence</a> </p>
 </li>

</ul>

<div class="section" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-44473E52-82B4-55E7-AE85-15AC88CE5BEB"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-44473E52-82B4-55E7-AE85-15AC88CE5BEB"><!-- --></a><h2 class="sectiontitle">Structure of
the state machine stack</h2> <p>The stack itself is represented as an array
of <a href="GUID-DDCE8054-1656-34EF-9CBC-53C796BFD5A6.html"><span class="apiname">TMMCMachineStackEntry</span></a> objects contained within the state
machine object <a href="GUID-022AC0FE-86EE-3908-A9F8-4A33D04A68A5.html"><span class="apiname">TMMCStateMachine</span></a>. </p>
 <p>The state machine
maintains a "pointer", <a href="GUID-022AC0FE-86EE-3908-A9F8-4A33D04A68A5.html#GUID-022AC0FE-86EE-3908-A9F8-4A33D04A68A5__GUID-5EC9B7D0-A3A9-35DF-A91D-65920372C9A4"><span class="apiname">TMMCStateMachine::iSP</span></a>, to the current
state entry. This is not a true pointer, but just a value that indexes into
the array. However, for all practical purposes it has the effect of a pointer.
Each state entry in the stack is thought of as having a parent-child relationship
with the other. </p>
 <p>Each state entry maintains three pieces of information: </p>
 <ul>
<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-81454E68-4603-5211-8F9F-70F0F2F4B95D"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-81454E68-4603-5211-8F9F-70F0F2F4B95D"><!-- --></a><p>A pointer to the state
machine function. </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-B20834EB-3EAE-5D79-8564-8B2A5490A057"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-B20834EB-3EAE-5D79-8564-8B2A5490A057"><!-- --></a><p>A variable containing
the current state; the value and meaning of the state is defined by the state
machine function. </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-32AFB296-0D5F-5FF7-9ECD-C9F798E04542"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-32AFB296-0D5F-5FF7-9ECD-C9F798E04542"><!-- --></a><p>A bitmask of <a href="GUID-FF4AB1CF-7A2C-3FC6-B123-D6819E1BCDCA.html"><span class="apiname">TMMCErr</span></a> defined
error conditions; these are set by the parent state machine function so that
it gets the chance to trap those errors if the child state machine function
returns those errors. Errors are propagated up the stack, and any error conditions
not trapped at any level in the state machine hierarchy leads to the state
machine terminating with that error value. </p>
 </li>

</ul>
 <div class="fignone" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-064C53DB-6A96-5C6D-B3CD-B40A0251EF66"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-064C53DB-6A96-5C6D-B3CD-B40A0251EF66"><!-- --></a>
<img src="GUID-D8911BE6-100D-588A-8E5C-A429A72AFCDA_d0e397743_href.png"/>
</div>
 <p>In general, the overall state of the state machine reflects the
state of the current state entry; for example, <a href="GUID-E32D6BC3-F8D9-3F7E-94F6-56633B645D6A.html#GUID-E32D6BC3-F8D9-3F7E-94F6-56633B645D6A__GUID-48F37107-2D11-3550-890B-D79844A97DBF"><span class="apiname">TMMCStatemachine::State()</span></a> returns
the state held in the current state entry. </p>
 <p>While the flow of control
through a stack can be complex, the following diagram shows a short example
snapshot. Here, the current state in the current stack entry is <samp class="codeph">Sn</samp> and
is handled by the function <samp class="codeph">PF()</samp>. The code decides to pass
control to the child function <samp class="codeph">CF()</samp>, but ensures that, on
completion, the next state in the current stack entry will be <samp class="codeph">Sn+1</samp>. </p>
 <div class="fignone" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-6ACBC49E-14EE-526B-A1A3-426B64BF8476"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-6ACBC49E-14EE-526B-A1A3-426B64BF8476"><!-- --></a>
<img src="GUID-D2D41326-BA88-5A02-805B-5EAEC29ADB5D_d0e397770_href.png"/>
</div>
 <p>For example, the <a href="GUID-B5193656-9819-3E00-A335-EEF1726115A5.html#GUID-B5193656-9819-3E00-A335-EEF1726115A5__GUID-F71A4421-2F9E-39FD-A352-97ECAAFE822D"><span class="apiname">DMMCStack::CIMUpdateAcqSM()</span></a> function
implements the CIM_UPDATE_ACQ macro as defined by the <em>MultiMediaCard System
Specification</em>, and is a typical state machine function. </p>
 <p>Most commands
and macros involve one or more asynchronous operations and while such operations
are outstanding, a session is blocked. While a session is blocked, its state
machine dispatch function is not called. As soon an asynchronous event removes
the blocking condition, control returns to the state machine. </p>
 </div>

<div class="section" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-E8FCFD65-4664-52EE-B658-FCABF50D501D"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-E8FCFD65-4664-52EE-B658-FCABF50D501D"><!-- --></a><h2 class="sectiontitle">Structure of
a state machine function</h2> <p>State machine functions are defined and
implemented in the <a href="GUID-B5193656-9819-3E00-A335-EEF1726115A5.html"><span class="apiname">DMMCStack</span></a> class in pairs: one as a static
function, and the other as a member function. The static variant takes a <samp class="codeph">TAny*</samp> pointer
that is cast to a <a href="GUID-B5193656-9819-3E00-A335-EEF1726115A5.html"><span class="apiname">DMMCStack</span></a> pointer, and the <samp class="codeph">DMMCStack</samp> member
function is then called: </p>
 <pre class="codeblock" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-F5EEA20F-2312-5394-84C4-5E568995291A"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-F5EEA20F-2312-5394-84C4-5E568995291A"><!-- --></a>TMMCErr DMMCStack::FunctionNameSMST( TAny* aPtr )
    {
    return( STATIC_CAST(DMMCStack*,aPtr)-&gt;FunctionNameSM() );
    }
</pre>
 <pre class="codeblock" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-3C01127E-4EBA-59AC-91F8-1F004A74E45B"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-3C01127E-4EBA-59AC-91F8-1F004A74E45B"><!-- --></a>TMMCErr DMMCStack::FunctionNameSM()
    {
    enum states {EStBegin=0, EStNext,…, EStEnd };    // Enumeration of states for this state machine
    DMMCSession&amp; s = Session();

    SMF_BEGIN
    // State EStBegin
    // Actions for state EStBegin

    SMF_STATE( EStNext )
    // State EStNext
    // Actions for state EStNext

    SMF_END
    }
</pre>
 <p>A state machine function can release control and wait to be
re-entered by returning zero. If its session is not blocked then that will
happen immediately. If the state machine function returns non-zero, the session
will be completed with that error code unless the parent state machine function
has explicitly intercepted such an error by setting the trap mask. </p>
 <ul>
<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-BEE3954A-733D-55CE-B09C-4B49304B44E1"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-BEE3954A-733D-55CE-B09C-4B49304B44E1"><!-- --></a><p> <a href="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7.html#GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-901D8456-F8D3-5E92-B3DA-EFE556D8C48B">Important points to note</a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-DA29FD1E-93EF-56C1-9650-8CE22B655897"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-DA29FD1E-93EF-56C1-9650-8CE22B655897"><!-- --></a><p> <a href="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7.html#GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-DBBA1450-AE5A-50E5-9B8C-F697CEFAD590">Blocking on an asynchronous request</a> </p>
 </li>

</ul>
 <p id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-901D8456-F8D3-5E92-B3DA-EFE556D8C48B"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-901D8456-F8D3-5E92-B3DA-EFE556D8C48B"><!-- --></a><strong>Important points to note</strong> </p>
 <p>Each
state machine function must define a list of states that can exist. States
are defined as an enumeration whose first and last values <em>must</em> be labelled <samp class="codeph">EStBegin</samp> and <samp class="codeph">EStEnd</samp>,
respectively. <samp class="codeph">EStBegin</samp> must have the value zero. Any other
intermediate states are program defined. </p>
 <p>To make the state machine
functions more readable, a number of macros exist to help with the layout
of the function code, and to control program flow. The most basic macros are <a href="GUID-C095E583-3E71-31F3-B092-627357D72958.html"><span class="apiname">SMF_BEGIN</span></a>, <a href="GUID-38811BD9-F27C-3408-A04F-053314A2CF84.html"><span class="apiname">SMF_STATE</span></a> and <a href="GUID-C1089896-DD68-399C-BF34-2495C51A0CA1.html"><span class="apiname">SMF_END</span></a> that expand into a switch statement. The above code expands
to: </p>
 <pre class="codeblock" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-16AE9141-5BE1-5B54-B083-7F60133DD018"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-16AE9141-5BE1-5B54-B083-7F60133DD018"><!-- --></a>TMMCErr DMMCStack::FunctionNameSM()
{
enum states {EStBegin=0, EStNext,…, EStEnd };    // Enumeration of states for this state machine
DMMCSession&amp; s = Session();

TMMCStateMachine&amp; m = Machine();            //SMF_BEGIN
const TMMCErr err = m.SetExitCode( 0 );        //SMF_BEGIN
for(;;)                                        //SMF_BEGIN
    {                                        //SMF_BEGIN
    switch(m.State())                        //SMF_BEGIN
        {                                    //SMF_BEGIN
        case EStBegin:                        //SMF_BEGIN
            {                                //SMF_BEGIN
            if(err) (void)0;                //SMF_BEGIN 
            // State EStBegin
            // Actions for state EStBegin

            }                                //SMF_STATE
        case EStNext:                        //SMF_STATE
            {                                //SMF_STATE
            // State EStNext
            // Actions for state EStNext

        case EStEnd:                                                //SMF_END
            break;                                                    //SMF_END
            default:                                                //SMF_END
            DMMCController::Panic(DMMCController::EMMCMachineState);//SMF_END
        }                                                            //SMF_END
        break;                                                        //SMF_END
    }                                                                //SMF_END
return(m.Pop());                                                    //SMF_END
}</pre>
 <p>Notes: </p>
 <ul>
<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-7542D030-2641-5A15-A5AF-A02C491B24BB"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-7542D030-2641-5A15-A5AF-A02C491B24BB"><!-- --></a><p>be aware that SMF_BEGIN
generates an open curly bracket while SMF_STATE generates a corresponding
close bracket, and SMF_END closes the switch statement. </p>
 </li>

</ul>
 <p>You need to be aware of the code that is generated by these macros.
In particular, some such as SMF_BEGIN generate an opening curly brace, while
others such as SMF_STATE generate a corresponding close curly brace. Also,
you need to know whether a macro generates a <samp class="codeph">break;</samp> or a <samp class="codeph">return;</samp> statement.
Lack of awareness here may cause code to be generated that flows from one
case statement to another, which may not be your intent. </p>
 <ul>
<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-7C57CF3E-0EB9-56A4-A07A-86027F5B42BA"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-7C57CF3E-0EB9-56A4-A07A-86027F5B42BA"><!-- --></a><p> <a href="GUID-C095E583-3E71-31F3-B092-627357D72958.html"><span class="apiname">SMF_BEGIN</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-9A87EEA6-6D40-53E1-BCEE-F9A20C22D51D"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-9A87EEA6-6D40-53E1-BCEE-F9A20C22D51D"><!-- --></a><p> <a href="GUID-C1089896-DD68-399C-BF34-2495C51A0CA1.html"><span class="apiname">SMF_END</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-3ADD2CCB-4C83-54EC-80DB-3C8CFDDDCB7A"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-3ADD2CCB-4C83-54EC-80DB-3C8CFDDDCB7A"><!-- --></a><p> <a href="GUID-2BA7F4A7-ECB0-3839-809B-4C32D4F451BA.html"><span class="apiname">SMF_NEXTS</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-41D972A7-18DE-5CE5-B0D6-039B0126199C"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-41D972A7-18DE-5CE5-B0D6-039B0126199C"><!-- --></a><p> <a href="GUID-ACD776A5-5439-3BE9-8DD8-B537D8C2C637.html"><span class="apiname">SMF_CALL</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-87C8FC8C-F810-5B3F-A7CC-99D6515F8F04"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-87C8FC8C-F810-5B3F-A7CC-99D6515F8F04"><!-- --></a><p> <a href="GUID-3802119E-0FC0-3B7C-9582-21563EC9AF61.html"><span class="apiname">SMF_CALLWAIT</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-89669A58-5168-508A-AF9F-34C3347F0A69"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-89669A58-5168-508A-AF9F-34C3347F0A69"><!-- --></a><p> <a href="GUID-2B6FA032-F8F9-3205-9CBB-EFB96691ACC9.html"><span class="apiname">SMF_CALLMYS</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-A6C9952A-223E-5687-B67C-D89D50070BDB"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-A6C9952A-223E-5687-B67C-D89D50070BDB"><!-- --></a><p> <a href="GUID-C1D65C79-F781-3E22-AA73-F75BA2516F6F.html"><span class="apiname">SMF_CALLMEWR</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-7FF0DFC9-D9DC-5E08-B668-4BC62B6E50EC"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-7FF0DFC9-D9DC-5E08-B668-4BC62B6E50EC"><!-- --></a><p> <a href="GUID-A143CA61-AA6B-3C5F-9E58-50BAF3786262.html"><span class="apiname">SMF_INVOKES</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-F02BE381-0BA2-5E9D-AFB7-9064FBADC64C"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-F02BE381-0BA2-5E9D-AFB7-9064FBADC64C"><!-- --></a><p> <a href="GUID-A73CAEB2-2413-371E-A56F-2757C0723514.html"><span class="apiname">SMF_INVOKEWAITS</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-A39E56F8-DE55-5EDE-A955-24E198026F39"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-A39E56F8-DE55-5EDE-A955-24E198026F39"><!-- --></a><p> <a href="GUID-94214574-2CCD-3BE4-ABD4-6A58328B29A2.html"><span class="apiname">SMF_WAIT</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-1CB69F09-3BAC-5C41-B20E-5A2896C0E18E"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-1CB69F09-3BAC-5C41-B20E-5A2896C0E18E"><!-- --></a><p> <a href="GUID-33FBF199-09B8-32C3-BAD6-92D277722DB3.html"><span class="apiname">SMF_WAITS</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-46D7BB96-3EC7-5207-BEE4-1E3ABB145D6B"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-46D7BB96-3EC7-5207-BEE4-1E3ABB145D6B"><!-- --></a><p> <a href="GUID-B13D0665-AD49-348F-8795-67E8761B0BC8.html"><span class="apiname">SMF_RETURN</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-A9A4DB91-2648-534D-BEA3-57A23147D750"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-A9A4DB91-2648-534D-BEA3-57A23147D750"><!-- --></a><p> <a href="GUID-2BA73A03-7379-394C-B9E8-4525316AF91F.html"><span class="apiname">SMF_EXIT</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-E75E1BF0-CD8B-5EEA-98EA-13176AE0A308"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-E75E1BF0-CD8B-5EEA-98EA-13176AE0A308"><!-- --></a><p> <a href="GUID-57CF6330-1EA6-36A9-B2A1-2BB360B1E7FD.html"><span class="apiname">SMF_EXITWAIT</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-D0617F39-4CF6-5FA7-995C-50688A82E703"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-D0617F39-4CF6-5FA7-995C-50688A82E703"><!-- --></a><p> <a href="GUID-6E9EF7EB-A9A2-3FA1-902D-188B4930927F.html"><span class="apiname">SMF_JUMP</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-83791CBF-298A-5B5F-A9A0-8FB902AE81EB"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-83791CBF-298A-5B5F-A9A0-8FB902AE81EB"><!-- --></a><p> <a href="GUID-85E63D6B-521B-309A-A1B1-18FDFCF626A0.html"><span class="apiname">SMF_JUMPWAIT</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-F657F501-47AE-57D0-BEB6-A051176FC279"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-F657F501-47AE-57D0-BEB6-A051176FC279"><!-- --></a><p> <a href="GUID-BF735A08-6E69-374F-8052-EF6CA101A3C3.html"><span class="apiname">SMF_GOTONEXTS</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-F7D1B6D8-51A2-5C73-A709-1BB10CD27620"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-F7D1B6D8-51A2-5C73-A709-1BB10CD27620"><!-- --></a><p> <a href="GUID-AA215584-34D9-36DA-A05A-8A4DF4636D5E.html"><span class="apiname">SMF_GOTOS</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-042539CB-3019-57A2-B0AD-F1417756F842"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-042539CB-3019-57A2-B0AD-F1417756F842"><!-- --></a><p> <a href="GUID-38811BD9-F27C-3408-A04F-053314A2CF84.html"><span class="apiname">SMF_STATE</span></a> </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-ADD382E6-32C0-5773-8958-057F440C3FEC"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-ADD382E6-32C0-5773-8958-057F440C3FEC"><!-- --></a><p> <a href="GUID-11B9D102-4548-3321-8318-26E940273880.html"><span class="apiname">SMF_BPOINT</span></a> </p>
 </li>

</ul>
 <p id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-DBBA1450-AE5A-50E5-9B8C-F697CEFAD590"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-DBBA1450-AE5A-50E5-9B8C-F697CEFAD590"><!-- --></a><strong> Blocking on an asynchronous
request</strong> </p>
 <p>The state machine can be made to block. This is done so
that you can wait for an asynchronous operation to complete. When the operation
completes, it unblocks the state machine. There are two stages to blocking
a state machine: </p>
 <ul>
<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-544A1BE8-2896-5CEB-ADEB-4F63E26389C4"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-544A1BE8-2896-5CEB-ADEB-4F63E26389C4"><!-- --></a><p>Call <a href="GUID-B5193656-9819-3E00-A335-EEF1726115A5.html#GUID-B5193656-9819-3E00-A335-EEF1726115A5__GUID-E7B38752-F9AB-3A66-8FB6-E321717A63B5"><span class="apiname">DMMCStack::BlockCurrentSession()</span></a> to
indicate that the state machine associated with the current session is to
be blocked </p>
 </li>

<li id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-BDB03808-C220-5518-B0E7-232845FD0AD6"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-BDB03808-C220-5518-B0E7-232845FD0AD6"><!-- --></a><p>Execute one of the SMF_xxxWAIT
macros to return from the current state machine function and wait. </p>
 </li>

</ul>
 <p>Note that the state machine function <em>must</em> return by calling
one of the SMF_xxxWAIT macros. It must not poll or sit in a loop! The state
machines are not threaded, and this means that CPU time can only be given
to other tasks if the function returns. </p>
 <p> <a href="GUID-B5193656-9819-3E00-A335-EEF1726115A5.html#GUID-B5193656-9819-3E00-A335-EEF1726115A5__GUID-E7B38752-F9AB-3A66-8FB6-E321717A63B5"><span class="apiname">DMMCStack::BlockCurrentSession()</span></a> takes
an argument describing the type of block. The state machine will only unblock
when an unblock request with the matching argument is called. In the platform
specific layer of the MultiMediaCard controller, you should always set the <a href="GUID-8A9A2DD2-C630-3651-8374-17BCF2A09AC4.html"><span class="apiname">KMMCBlockOnASSPFunction</span></a> bit
in the argument passed to <samp class="codeph">BlockCurrentSession()</samp>. </p>
 <p>To
unblock the state machine, call <a href="GUID-B5193656-9819-3E00-A335-EEF1726115A5.html#GUID-B5193656-9819-3E00-A335-EEF1726115A5__GUID-E1FEFAD3-CD02-38AF-8E45-41099192D583"><span class="apiname">DMMCStack::UnBlockCurrentSession()</span></a> setting
the <a href="GUID-8A9A2DD2-C630-3651-8374-17BCF2A09AC4.html"><span class="apiname">KMMCBlockOnASSPFunction</span></a> bit in the flags argument passed
to the function, and also an error code. This will invoke the state machine
scheduler, which will re-start the state machine. </p>
 <p>Note that further
state machine processing must take place in a DFC rather than within the interrupt
service routine (ISR), and this can be forced by ORing the session status, <a href="GUID-0186BEDE-8E28-3F8C-8CAE-A8B92F41F47A.html#GUID-0186BEDE-8E28-3F8C-8CAE-A8B92F41F47A__GUID-252B39FE-C203-37AD-82A4-63E9BFFD3473"><span class="apiname">DMMCSession::iState</span></a>,
with the <a href="GUID-5CF9ED11-2F3A-3E9B-9BFF-87DBE261F097.html"><span class="apiname">KMMCSessStateDoDFC</span></a> bit <em>before</em> unblocking
the session. The bit has the effect of queueing a DFC to resume the state
machine at some later stage, before returning to the ISR. </p>
 <p>The following
code shows the idea: </p>
 <pre class="codeblock" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-C4C8C8EA-4A16-5E9C-A64D-194D7D17403C"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-C4C8C8EA-4A16-5E9C-A64D-194D7D17403C"><!-- --></a>TMMCErr DMMCStackAssp::DoSomethingSM()
    {
    enum states {EStBegin=0, EStDone,EStEnd };    // enumeration of states for this state machine

    SMF_BEGIN
    // start the asynchronous operation
    BlockCurrentSession( KMMCBlockOnASSPFunction );
    StartAsynchronousOp();

    // block and wait. Go to state EStDone when the asynchronous op is complete
    SMF_WAITS( EStDone );
    
    SMF_STATE( EStDone )
    // operation is complete, check for errors and return from state machine
    TInt errors = CheckForHardwareErrors();
    SMF_RETURN( errors );

    SMF_END
    }
</pre>
 <pre class="codeblock" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-5CE18C2D-2780-5966-BC26-DD33D31BB5B3"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-5CE18C2D-2780-5966-BC26-DD33D31BB5B3"><!-- --></a>void TMMCInterrupt::Service( TAny* aParam )
    {
    Session().iState |= KMMCSessStateDoDFC;
    UnBlockCurrentSession(KMMCBlockOnASSPFunction, KMMCErrNone);
    }
</pre>
 </div>

<div class="section" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-667C5A70-0ABB-525F-A309-58102E380400"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-667C5A70-0ABB-525F-A309-58102E380400"><!-- --></a><h2 class="sectiontitle">Example of
a state machine calling sequence</h2> <p>This shows the state machine calling
sequence that implements the reading of a single block on a MultiMediaCard,
where the card is not yet selected. Note that the lowest level state machine
function called is <samp class="codeph">IssueMMCCommandSM()</samp>, which is implemented
by the base port. </p>
 <div class="fignone" id="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-A67E1B8E-322A-5AC8-9EEA-AC24C8868E81"><a name="GUID-80E0DB93-A96A-54A8-A201-E11935418BE7__GUID-A67E1B8E-322A-5AC8-9EEA-AC24C8868E81"><!-- --></a>
<img src="GUID-A51C3E48-3ED0-519B-A128-C5175D7E175B_d0e398169_href.png"/>
</div>
 </div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-C6825C8F-8020-58CF-A09E-34558B1542DE.html" title="This section describes the detailed structure and operation of the MMC Controller.">MMC Controller Operation</a></div>
</div>
</div>
   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>