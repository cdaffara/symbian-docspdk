<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2010"/>
<meta name="DC.rights.owner" content="(C) Copyright 2010"/>
<meta name="DC.Type" content="concept"/>
<meta name="DC.Title" content="Client MTM"/>
<meta name="DC.Relation" scheme="URI" content="GUID-400E4702-973A-5CAC-9F9C-3A10121F856A.html"/>
<meta name="DC.Relation" scheme="URI" content="index.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-5DD1010C-1648-5086-BA80-BC25F3C7A2C4.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-C290FA5E-8E41-5D19-B8C1-F88491EE6388.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-B394A824-8745-505E-8429-8B9B6D418387.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-44CF5471-564E-5790-935B-51193A4978D6.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-8B843382-D27A-5E36-8F60-304903F3AA41.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-400E4702-973A-5CAC-9F9C-3A10121F856A.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-59217FA7-3078-53CA-88B3-78D6FB788271.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-BAD138D5-2914-5C6E-9FA4-F7A3CCB85E6D.html"/>
<meta name="DC.Relation" scheme="URI" content="GUID-1E2DB50A-D8D7-595D-8448-77F057655E82.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC"/>
<meta name="DC.Language" content="en"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Client MTM</title>

     
<link type="text/css" rel="stylesheet" href="css/common.css" media="screen"/>
<link type="text/css" rel="stylesheet" href="css/sdl.css" media="screen"/>

<!--[if IE]>
<link href="css/iefix.css" rel="stylesheet" type="text/css" media="screen" />
<![endif]-->



     <link rel="stylesheet" type="text/css" href="nokiacxxref.css"/></head>
<body id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC"><!-- --></a>


<?php include_once (CURRENT_SKIN_PATH.'/sdl_header.html'); ?>
<div id="sdl_container">
   <div id="leftMenu">  
 <div id="expandcontractdiv">
    <a id="collapseTree" href="javascript:tree.collapseAll()">Collapse all</a>
    <a id="index" href="index.html">Symbian^3 Product Developer Library</a>        
</div>
     <iframe style="border:none" height="800" width="300" src="index-toc.html"></iframe>
<div id="treeDiv1">&#160;</div>
     <script type="text/javascript">
	var currentIconMode = 0; window.name="id2563754 id2404348 id2404397 id2404434 id2404448 id2404463 id2404477 ";
	YAHOO.util.Event.onDOMReady(buildTree, this,true);
    </script>
     
</div>

<div id="sdl_content">


<div class="breadcrumb"><a href="index.html" title="Symbian^3 Product Developer Library">Symbian^3 Product Developer Library</a> &gt; <a href="GUID-32E29020-1956-461A-B79A-1492E06049E7.html" title="The Symbian Guide describes the architecture and functionality of the platform, and provides guides on using its APIs.">Symbian Guide</a> &gt; <a href="GUID-5DD1010C-1648-5086-BA80-BC25F3C7A2C4.html">Messaging Middleware Guide</a> &gt; <a href="GUID-C290FA5E-8E41-5D19-B8C1-F88491EE6388.html">Messaging Framework</a> &gt; <a href="GUID-B394A824-8745-505E-8429-8B9B6D418387.html">Message Server and Store</a> &gt; <a href="GUID-44CF5471-564E-5790-935B-51193A4978D6.html" title="This section lists the concepts that are related to Message Server and Store.">Message Server and Store Concepts</a> &gt; <a href="GUID-8B843382-D27A-5E36-8F60-304903F3AA41.html">Message Type Module</a> &gt; <a href="GUID-400E4702-973A-5CAC-9F9C-3A10121F856A.html">Types of MTM</a> &gt; </div>
<h1 class="topictitle1">Client
MTM</h1>
<div>
<p>Client MTMs provide a client-side API to functionality provided by the
Server MTM, mainly for message manipulation and transport. It acts as the
interface between the internal representation of a message’s data and the
User Interface (UI) MTM. This architecture provides certain advantages; for
example, a UI MTM can offer a user interface to enter message addresses without
knowing the address storage format. Message client applications that do not
require a user interface can use these client-side functions directly for
automated message handling. </p>

<p>The Message Server entry with which Client MTMs currently work is referred
to as the context. UI MTMs always operate on the contexts set through Client
MTMs. </p>

<p>Client MTMs offer some or all of the following capabilities: </p>

<ul>
<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-4327B533-04C0-5110-B8AD-90EC90C73D32"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-4327B533-04C0-5110-B8AD-90EC90C73D32"><!-- --></a><p>Address list manipulation </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-FC4908FC-5958-5815-90EB-D601B4710247"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-FC4908FC-5958-5815-90EB-D601B4710247"><!-- --></a><p>Creation of forward
and response messages </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-CF8196EB-1C40-50D0-86AA-0F2C954CBC5D"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-CF8196EB-1C40-50D0-86AA-0F2C954CBC5D"><!-- --></a><p>Message subject access </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-51B25D57-A577-5375-9DD6-D398C8B860A8"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-51B25D57-A577-5375-9DD6-D398C8B860A8"><!-- --></a><p>Message validation </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-4345AB18-2096-5312-955D-EACE72DCA52F"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-4345AB18-2096-5312-955D-EACE72DCA52F"><!-- --></a><p>Internalising and externalising
MTM-specific data to the Message Store </p>
 </li>

</ul>

<div class="section" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-BCFBE2C5-2C90-5E43-9B21-0D80A469CEAB"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-BCFBE2C5-2C90-5E43-9B21-0D80A469CEAB"><!-- --></a><h2 class="sectiontitle">Client MTM
base class</h2> <p>The base class for Client MTMs is <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html"><span class="apiname">CBaseMtm</span></a> which
provides a high-level interface for accessing and manipulating a Message Server
entry </p>
 <p>The following are some significant functions in <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html"><span class="apiname">CBaseMtm</span></a>.
Some functions are implemented by the base class, and others must be implemented
in a derived class: </p>
 <ul>
<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-8E6AB26D-BDD2-5D5E-BEDD-5371EE86834D"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-8E6AB26D-BDD2-5D5E-BEDD-5371EE86834D"><!-- --></a><p> <strong>Context functions</strong>  </p>
 <p>The <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-00C140DE-012F-3785-A628-E8D1330438B8"><span class="apiname">CBaseMtm::SetCurrentEntryL</span></a> <samp class="codeph">(CMsvEntry                 *)</samp> and <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-016A5DFD-5C88-3531-A5F3-456884CAC041"><span class="apiname">CBaseMtm::SwitchCurrentEntryL</span></a> <samp class="codeph">(TMsvId)</samp> functions
change the Message Server entry (the context) on which later actions are performed.
After creating a new Client MTM object, a message client application must
set an initial context before using other functions. </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-1E3E98F7-FBBF-5594-A7EF-93D7106FD3D3"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-1E3E98F7-FBBF-5594-A7EF-93D7106FD3D3"><!-- --></a><p> <strong>Store and restore
entry data functions</strong>  </p>
 <p>The changes that a message client application
makes to a message context through Client MTM functions, such as altering
the body text obtained through <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-072E627F-8AB4-3C90-AD48-A5AF6A39581B"><span class="apiname">CBaseMtm::Body()</span></a>, are, for
efficiency, cached in memory by a Client MTM. The message store (<a href="GUID-A0F2B215-C453-3CB8-A659-29CB0B4CF0A7.html"><span class="apiname">SaveMessageL()</span></a>)and
restore (<a href="GUID-DF6E56F8-3B05-3D34-8500-BDA77BABD05D.html"><span class="apiname">LoadMessageL()</span></a>), functions are concerned with
transferring data between that cache and committed storage. </p>
 <p> <strong>Note:</strong> Unlike
message contexts, message client applications are not expected to manipulate
directly contexts for message services. Instead, the corresponding <a href="GUID-C197C9A7-EA05-3F24-9854-542E984C612D.html"><span class="apiname">User</span></a> Interface
MTM provides a dialog to allow the user to alter service settings, and calls
Client MTM functions to handle their retrieval and storage. </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-A0FDCB02-3C4E-5CB0-A374-61C89889621B"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-A0FDCB02-3C4E-5CB0-A374-61C89889621B"><!-- --></a><p> <strong>Store and restore
body text functions</strong>  </p>
 <p>The base class maintains a private <a href="GUID-39945DA4-B362-3DF6-BF9E-DD079EEA7934.html"><span class="apiname">CRichText</span></a> object
cache to store the body text for the current context. This can be accessed
for reading and writing by message client applications through <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-072E627F-8AB4-3C90-AD48-A5AF6A39581B"><span class="apiname">CBaseMtm::Body()</span></a>.
The <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-A036C34A-EFB9-3E98-983B-0DFF1EE8CD85"><span class="apiname">CBaseMtm::StoreBodyL()</span></a> <samp class="codeph">(CMsvStore &amp;)</samp> and <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-43AF1C02-C435-3450-A549-8AECE9F6CAB0"><span class="apiname">CBaseMtm::RestoreBodyL()</span></a> <samp class="codeph">(CMsvStore
&amp;)</samp> functions encapsulate the retrieval and storage of this <a href="GUID-39945DA4-B362-3DF6-BF9E-DD079EEA7934.html"><span class="apiname">CRichText</span></a> object
to a <a href="GUID-8CB90FA2-A6CF-3FA2-81FF-7D22EFD9C2CE.html"><span class="apiname">CMsvStore</span></a>. </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-B44CFD8D-DB97-5A4D-B876-EA04D464A5B1"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-B44CFD8D-DB97-5A4D-B876-EA04D464A5B1"><!-- --></a><p> <strong>Address list functions</strong>  </p>
 <p>The
format and storage of message addresses is MTM-specific. The <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-51A8768D-684A-3668-98BF-AB88D676DEB5"><span class="apiname">CBaseMtm::AddresseeList()</span></a> <samp class="codeph">const</samp>, <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-D3DFE444-DB84-331C-BC3F-AB12E148CD00"><span class="apiname">CBaseMtm::AddAddresseeL</span></a> <samp class="codeph">(const TDesC &amp;)</samp>, and <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-770E749C-BA7F-3F31-B7B8-F2C21F4F06A1"><span class="apiname">CBaseMtm::RemoveAddressee</span></a> <samp class="codeph">(TInt)</samp> allow
clients to access address information in a generic way without having MTM-specific
knowledge. </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-F1E2AAD3-41E0-522A-B7AC-7090EE823807"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-F1E2AAD3-41E0-522A-B7AC-7090EE823807"><!-- --></a><p> <strong>MTM-specific client
functions</strong>  </p>
 <p>MTM components can offer protocol-specific functionality
not provided by base class interface functions. MTM components define IDs
that correspond to each protocol-specific operation offered, and implement
the <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-A5B6CDAC-7C02-35F4-840E-35932B438FD8"><span class="apiname">CBaseMtm::InvokeSyncFunctionL()</span></a> and <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html#GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D__GUID-05327221-98A9-35FA-BD28-D6323BE449D1"><span class="apiname">CBaseMtm::InvokeAsyncFunctionL()</span></a> functions
to allow clients to access these operations by passing in the appropriate
ID. These functions are provided to allow the MTM component to offer both
synchronous and asynchronous functionality. Message client applications can
dynamically add user-interface features for these operations using <a href="GUID-899C6D87-5712-34A7-902C-EA452894700C.html#GUID-899C6D87-5712-34A7-902C-EA452894700C__GUID-75DE35D7-4738-38C0-9BFA-A066F67B114B"><span class="apiname">CBaseMtmUiData::MtmSpecificFunctions()</span></a>. </p>
 </li>

<li id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-A4A3ED85-EAC5-58BC-BB40-E40949A84B66"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-A4A3ED85-EAC5-58BC-BB40-E40949A84B66"><!-- --></a><p> <strong>Query function</strong>  </p>
 <p>The
Client MTM <a href="GUID-E32E2F1C-62C5-3635-BA60-3E547C32DB9C.html"><span class="apiname">QueryCapability()</span></a> function is used to inquire
whether an MTM supports a given feature. The first argument is a UID defined
to correspond to a particular capability. The function returns a system error
code and the response (whether the MTM supports the queried capability) is
passed back through the second (by-reference)<samp class="codeph">aResponse</samp> parameter.
This value can be an integer or a bit set, depending on the capability. </p>
 <p>The
UIDs for the different types of query are as follows: </p>
 
<div class="tablenoborder"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-6ADE624E-8B18-58F9-9386-79A75E72E0C7"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-6ADE624E-8B18-58F9-9386-79A75E72E0C7" frame="border" border="1" rules="all">
<thead align="left">
<tr>
<th class="cellrowborder" valign="top" id="d2017458e276">UID</th>

<th class="cellrowborder" valign="top" id="d2017458e279">Capability</th>

</tr>

</thead>

<tbody>
<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMsvMtmQueryMaxBodySize</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Maximum message body size </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMtmQueryMaxTotalMsgSize</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Maximum total size of message. </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph"> KUidMtmQuerySupportedBody</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Character widths supported by message type. The returned value is
the sum of the appropriate values. The return type is either of KMtm7BitBody,
KMtm8BitBody, KMtm16BitBody, and KMtmBinaryBody) </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph"> KUidMtmQuerySupportAttachments</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>To check if the attachments are supported </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMtmQuerySupportSubject</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Does the MTM message type have a subject field </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph"> KUidMtmQuerySupportsFolder</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Does the MTM support folders </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph"> KUidMtmQueryOffLineAllowed</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Off-line operation allowed </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMtmQueryCanSendMsg</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Can send the message </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMtmQueryCanReceiveMsg</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Can receive the message </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMtmQueryMaxRecipientCount</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Maximum number of recipients (-1 indicates unlimited numbers). </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMtmQuerySendAsRequiresRenderedImage</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>When using the MTM in Send As, does a rendered image have to be
prepared. </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph"> KUidMtmQuerySendAsRenderingUid</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Printer driver UID for rendering the fax image. </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMsvMtmQueryEditorUid</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>UID of default message editor. </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMsvQuerySupportsBioMsg</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Does the MTM support BIO messages </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph"> KUidMsvQuerySupportsScheduling</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Does the MTM support scheduled sending. </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMtmQuerySupportsRecipientType</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Does the MTM support the use of recipient type. </p>
 </td>

</tr>

<tr>
<td class="cellrowborder" valign="top" headers="d2017458e276 "><p> <samp class="codeph">KUidMtmQuerySendAsMessageSendSupport</samp>  </p>
 </td>

<td class="cellrowborder" valign="top" headers="d2017458e279 "><p>Support for Sending messages using SendAs. </p>
 <p>If this is supported,
then the MTM supports sending messages created through the SendAs API. </p>
 </td>

</tr>

</tbody>

</table>
</div>
 <p>The following example is a snapshot of the Text MTM example. For
more implementation details, see <a href="GUID-5B9F2EEE-A5F6-5833-BFC4-3B063EA7EDF2.html">Messaging
Text MTM example code</a>. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-375C5493-8DAA-5B2D-B371-B7FD7DC2CCD1"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-375C5493-8DAA-5B2D-B371-B7FD7DC2CCD1"><!-- --></a>TInt CTextMtmClient::QueryCapability(TUid aCapability, TInt&amp; aResponse)
    {
    TInt error = KErrNone;
    switch (aCapability.iUid)
        {
        case KUidMtmQueryMaxBodySizeValue:
        case KUidMtmQueryMaxTotalMsgSizeValue:
            aResponse = KMaxTextMessageSize;
            break;
        case KUidMtmQuerySupportedBodyValue:
            aResponse = KMtm8BitBody + KMtm7BitBody;
            break;
        case KUidMtmQueryOffLineAllowedValue:
        case KUidMtmQueryCanReceiveMsgValue:
            aResponse = ETrue;
            break;
        case KUidMtmQuerySupportAttachmentsValue:
        default:
            return KErrNotSupported;
        }
    return error;
    }
</pre>
 </li>

</ul>
 <p>The <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html"><span class="apiname">CBaseMtm</span></a> class provides the virtual functions
for overriding in derived classes. </p>
 </div>

<div class="section" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-6DD0912E-1E82-5BAD-889C-5FA79E5E800C"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-6DD0912E-1E82-5BAD-889C-5FA79E5E800C"><!-- --></a><h2 class="sectiontitle">Client-side
operations</h2> <p>Many Messaging tasks can take a long time to complete.
For example, sending all items from the Outbox or downloading a large number
of items from a POP3 server. In these situations, the use of active objects
to wait for the completion of the task is inadequate, since applications also
require to obtain progress information while the task is running (for example,
to update a progress dialog). To solve this problem, most asynchronous functions
in Messaging create a <a href="GUID-AF724192-6580-3DE3-9287-3A005C0AA932.html"><span class="apiname">CMsvOperation</span></a> object and return a
pointer to it, as well as taking a <samp class="codeph">TRequestStatus&amp;</samp> parameter.
The <a href="GUID-AF724192-6580-3DE3-9287-3A005C0AA932.html"><span class="apiname">CMsvOperation</span></a> class is derived from <a href="GUID-067293BF-B28C-3CEC-92F4-1351A795EA7F.html"><span class="apiname">CActive</span></a> and
is used to obtain progress information about a long-running task. </p>
 <p>The
base class for all client-side Messaging operations is <a href="GUID-AF724192-6580-3DE3-9287-3A005C0AA932.html"><span class="apiname">CMsvOperation</span></a>.
The asynchronous methods in the <a href="GUID-177AF50B-14EF-3C45-AE22-1FEE5678261D.html"><span class="apiname">CBaseMtm </span></a> interface all
return a pointer to a <a href="GUID-AF724192-6580-3DE3-9287-3A005C0AA932.html"><span class="apiname">CMsvOperation</span></a> object. When you implement
an MTM, you will have to provide your own custom operations, derived from <a href="GUID-AF724192-6580-3DE3-9287-3A005C0AA932.html"><span class="apiname">CMsvOperation</span></a>,
and return those polymorphically from your implementations of the asynchronous
APIs. </p>
 <p><strong>Example</strong> </p>
 <p>The forward operation of the Text MTM
is explained in the following example. </p>
 <p>The forward operation is an
active object state machine that runs a series of asynchronous tasks one after
another and waits for each to complete before moving on to the next. After
the operation has been completed, an active object is notified through its <samp class="codeph">TRequestStatus</samp> passed
into the operation at construction. </p>
 <p>The forward operation is constructed
using standard two-phase construction. The <a href="GUID-93132FF9-512F-30EC-8AB0-BD3E98F668E6.html"><span class="apiname">NewL()</span></a> function
takes two arguments of a <a href="GUID-A4B1F874-27C0-3BB6-9D29-C35C75A5DB98.html"><span class="apiname">TMsvId</span></a> (source message and destination
folder) type, a <a href="GUID-2DA04D96-F0AD-3FDC-9E36-1C27D889AF4B.html"><span class="apiname">CMsvSession</span></a> reference, and the observer’s <samp class="codeph">TRequestStatus</samp>,
which is notified on completion. The active object is constructed and added
to the scheduler, and then <a href="GUID-C8E0575D-5A7F-3D00-9BE5-AD8D6DBCF2F7.html"><span class="apiname">ConstructL()</span></a> is called: </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-C046D5BB-A157-5F5D-9702-C9ED271B89E8"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-C046D5BB-A157-5F5D-9702-C9ED271B89E8"><!-- --></a>void CTxtMtmForwardOperation::ConstructL()
    {
    iObserverRequestStatus = KRequestPending;
    SetActive();
    TRequestStatus* stat = &amp;iStatus;
    User::RequestComplete(stat, KErrNone);
    }
</pre>
 <p>This has the effect of marking this stage of the operation
as complete and means that <a href="GUID-12C281FF-546C-318D-8783-F26B0F619E11.html"><span class="apiname">RunL()</span></a> is called at the next
opportunity. This simplifies the state machine because it means that all states
and tasks are started in <a href="GUID-12C281FF-546C-318D-8783-F26B0F619E11.html"><span class="apiname">RunL()</span></a> and not in <a href="GUID-C8E0575D-5A7F-3D00-9BE5-AD8D6DBCF2F7.html"><span class="apiname">ConstructL()</span></a>. </p>
 <p>The <a href="GUID-12C281FF-546C-318D-8783-F26B0F619E11.html"><span class="apiname">RunL()</span></a> function
starts each task and receives a notification when it completes. The current
task being executed is stored in <a href="GUID-51087246-DDFF-384B-9DB6-2525F8C73CA5.html"><span class="apiname">iProgress</span></a> and <a href="GUID-A36DDD59-6236-3549-9DEB-8BE1F402CB16.html"><span class="apiname">iState</span></a>,
as are the errors and the ID of the new forwarded message, once complete.
The default state for <a href="GUID-A36DDD59-6236-3549-9DEB-8BE1F402CB16.html"><span class="apiname">iState</span></a> on construction is <samp class="codeph">EInit</samp>. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-B223CED8-8391-5825-BAC7-E81ED08C7E7E"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-B223CED8-8391-5825-BAC7-E81ED08C7E7E"><!-- --></a>void CTxtMtmForwardOperation::RunL()
    {
    User::LeaveIfError(iStatus.Int());
    switch(iProgress.iState)
        {        
        case TTxtMtmForwardOpProgress::EInit:
            iProgress.iState =
               TTxtMtmForwardOpProgress::ECreateMessage;
            CreateMessageL();
            break;

        case TTxtMtmForwardOpProgress::ECreateMessage:
            iProgress.iState =
               TTxtMtmForwardOpProgress::EFormatBodyText;
            FormatBodyTextL();
            break;

        case TTxtMtmForwardOpProgress::EFormatBodyText:
            iProgress.iState =
               TTxtMtmForwardOpProgress::EFinished;
        
        default:
            break;
        }
    if(!IsActive())
        {
        TRequestStatus* stat = &amp;iObserverRequestStatus;
        User::RequestComplete(stat, KErrNone);
        }
    }
</pre>
 <p>If the state is <samp class="codeph">EInit</samp>, the <a href="GUID-12C281FF-546C-318D-8783-F26B0F619E11.html"><span class="apiname">RunL()</span></a> changes
state to <samp class="codeph">ECreateMessage</samp> and then calls <a href="GUID-E1D580C2-8B05-3A9E-8157-A3F849811AAB.html"><span class="apiname">CreateMessageL()</span></a> to
start the process of creating a message asynchronously. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-69C1C1DB-8813-56DC-8BDF-BF8B13D43583"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-69C1C1DB-8813-56DC-8BDF-BF8B13D43583"><!-- --></a>void CTxtMtmForwardOperation::CreateMessageL()
    {
</pre>
 <p>The function constructs a <a href="GUID-85BBE389-81F7-3E2F-A789-446D9BE2CC49.html"><span class="apiname">CMsvEntry</span></a> for
the source entry and then retrieves its index entry. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-5E1A2C12-832E-54BF-91A4-9755348FD298"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-5E1A2C12-832E-54BF-91A4-9755348FD298"><!-- --></a>delete iMsvEntry;
    iMsvEntry = NULL;
    iMsvEntry = iMsvSession.GetEntryL(iSourceMessage);
        
    // Get the entry to be forwarded    
    TMsvEntry forwardEntry = iMsvEntry-&gt;Entry();
</pre>
 <p>The context of <a href="GUID-55F14844-0FCB-380C-B797-956CA2B2CFE2.html"><span class="apiname">iMsvEntry</span></a> is changed to
the destination folder and an entry is created. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-ECBE0131-DCC1-5182-B8D9-DBA35F4FD42A"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-ECBE0131-DCC1-5182-B8D9-DBA35F4FD42A"><!-- --></a>// Set the context to the destination folder
    iMsvEntry-&gt;SetEntryL(iDestinationFolder);
</pre>
 <p>The index entry’s date is updated to reflect the current date. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-B7156135-805B-509E-8778-EA17E5B69AE6"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-B7156135-805B-509E-8778-EA17E5B69AE6"><!-- --></a>// Create the forwarded index entry
    forwardEntry.iDate.HomeTime();
    iMsvEntry-&gt;CreateL(forwardEntry);
</pre>
 <p>The <a href="GUID-CAE27183-B48C-3B02-A88D-98CC51475DC0.html"><span class="apiname">iFinalMsgId</span></a> member of the progress
is updated to reflect the newly created entry. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-2C15F0E2-64C9-507B-8997-D257DACE0EEB"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-2C15F0E2-64C9-507B-8997-D257DACE0EEB"><!-- --></a>iProgress.iFinalMsgId = forwardEntry.Id();

    // schedules the active object to complete so that this 
    // class's RunL method
    // will be called by the active scheduler
    SetActive();
</pre>
 <p>The operation’s <samp class="codeph">TRequestStatus</samp> is then flagged
to cause <a href="GUID-12C281FF-546C-318D-8783-F26B0F619E11.html"><span class="apiname">RunL()</span></a>. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-971DFF4A-E78F-5EBD-8DFB-616DA421E521"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-971DFF4A-E78F-5EBD-8DFB-616DA421E521"><!-- --></a>TRequestStatus* stat = &amp;iStatus;
    User::RequestComplete(stat, KErrNone);
     }
</pre>
 <p>When this happens,<samp class="codeph"> iProgress.iState</samp> is set
to <samp class="codeph">ECreateMessage</samp>, so the following code is executed: </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-1AA9893A-2CAA-5E64-A09A-E20689B38BAF"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-1AA9893A-2CAA-5E64-A09A-E20689B38BAF"><!-- --></a>case TTxtMtmForwardOpProgress::ECreateMessage:
    iProgress.iState =        TTxtMtmForwardOpProgress::EFormatBodyText;
    FormatBodyTextL();
    break;</pre>
 <p>The state is set to <samp class="codeph">EFormatBodyText</samp> and
the <a href="GUID-FC4144F7-9D46-3D30-8316-ED22170E37B0.html"><span class="apiname">FormatBodyTextL()</span></a> function is called. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-51C72DF8-9F39-51EA-BFFC-E4793A7B6621"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-51C72DF8-9F39-51EA-BFFC-E4793A7B6621"><!-- --></a>
void CTxtMtmForwardOperation::FormatBodyTextL()
   { 
</pre>
 <p>The function constructs a <a href="GUID-C5A6B3D4-1BDE-35B4-AC6B-DF517A4D4147.html"><span class="apiname">CParaFormatLayer</span></a>,
a <a href="GUID-7BEFAAD5-15C3-35A0-BDEF-BC56380D6CE5.html"><span class="apiname">CCharFormatLayer</span></a>, and a <a href="GUID-39945DA4-B362-3DF6-BF9E-DD079EEA7934.html"><span class="apiname">CRichText</span></a> object.
These objects are required to store the body text of the forwarded message. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-D02202DB-9E19-5873-86D6-6B0DCF035B74"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-D02202DB-9E19-5873-86D6-6B0DCF035B74"><!-- --></a>CParaFormatLayer* paraLayer = CParaFormatLayer::NewL();
   CleanupStack::PushL(paraLayer);
   CCharFormatLayer* charLayer = CCharFormatLayer::NewL();
   CleanupStack::PushL(charLayer);
   CRichText* body = CRichText::NewL(paraLayer, charLayer);
   CleanupStack::PushL(body);
</pre>
 <p>Then the context of <samp class="codeph">iMsvEntry</samp> is changed
to point at the source message and a read-only <a href="GUID-8CB90FA2-A6CF-3FA2-81FF-7D22EFD9C2CE.html"><span class="apiname">CMsvStore</span></a> is
opened for that entry. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-F3B582CD-867C-54FD-ACAB-0F50319601BC"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-F3B582CD-867C-54FD-ACAB-0F50319601BC"><!-- --></a>// Get the message store from the source entry
   iMsvEntry-&gt;SetEntryL(iSourceMessage);
   CMsvStore* readStore = iMsvEntry-&gt;ReadStoreL();
   CleanupStack::PushL(readStore);</pre>
 <p>The context of the <a href="GUID-55F14844-0FCB-380C-B797-956CA2B2CFE2.html"><span class="apiname">iMsvEntry</span></a> object
is changed to point at the newly created entry and a <a href="GUID-8CB90FA2-A6CF-3FA2-81FF-7D22EFD9C2CE.html"><span class="apiname">CMsvStore</span></a> is
opened for that entry. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-097EC5DB-9FCB-5D45-8B94-8E7DB5256005"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-097EC5DB-9FCB-5D45-8B94-8E7DB5256005"><!-- --></a>// Get the message store from the newly created destination 
   // entry
   iMsvEntry-&gt;SetEntryL(iProgress.iFinalMsgId);
   CMsvStore* writeStore = iMsvEntry-&gt;EditStoreL();
   CleanupStack::PushL(writeStore);

   // Get the body text from the source entry and write it
   // to the destination entry, prepending the forward 
   // prefix
   readStore-&gt;RestoreBodyTextL(*body);
   body-&gt;InsertL(0, KTxtMtmFwdPrefix);

     // this method performs a commit for us
   writeStore-&gt;StoreBodyTextL(*body);
 
   CleanupStack::PopAndDestroy(5, paraLayer); 

   // schedules the active object to complete so that this 
   // class's RunL method
   // will be called by the active scheduler
   SetActive();
   TRequestStatus* stat = &amp;iStatus;
   User::RequestComplete(stat, KErrNone);
   }
</pre>
 <p>The <samp class="codeph">iProgress.iState</samp> is set to <samp class="codeph">EFinished</samp>,
and because the object has not been activated the following conditional statement
evaluates true: </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-9CC7BAD3-B185-59F4-8CED-7BE23886661A"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-9CC7BAD3-B185-59F4-8CED-7BE23886661A"><!-- --></a>if(!IsActive())
    {
    TRequestStatus* stat = &amp;iObserverRequestStatus;
    User::RequestComplete(stat, KErrNone);
    }
</pre>
 <p>The observer active object’s <samp class="codeph">TRequestStatus</samp> is
flagged to let it know that the operation is complete. </p>
 <p>To return progress
from the operation, implement the <a href="GUID-E13013FF-09B9-3A9A-B471-0A9AE90E49EC.html"><span class="apiname">ProgressL()</span></a> and <a href="GUID-890A4968-EAD6-30F5-97D8-E6C07BA28B37.html"><span class="apiname">FinalProgress()</span></a> functions. <a href="GUID-E13013FF-09B9-3A9A-B471-0A9AE90E49EC.html"><span class="apiname">ProgressL()</span></a> must
be used to return progress information on the operation during processing,
and <a href="GUID-890A4968-EAD6-30F5-97D8-E6C07BA28B37.html"><span class="apiname">FinalProgress()</span></a> is guaranteed to return the status
of a completed operation. <a href="GUID-E13013FF-09B9-3A9A-B471-0A9AE90E49EC.html"><span class="apiname">ProgressL()</span></a> must be implemented
to leave with <samp class="codeph">KErrNotReady</samp> if the operation is not in progress,
and <a href="GUID-890A4968-EAD6-30F5-97D8-E6C07BA28B37.html"><span class="apiname">FinalProgress()</span></a> must panic if the operation is not
complete. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-4EAE052A-F445-589E-8B6A-983A579FBAE6"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-4EAE052A-F445-589E-8B6A-983A579FBAE6"><!-- --></a>const TDesC8&amp; CTxtMtmForwardOperation::ProgressL()
            {
            if (!IsActive())
                        {
                        User::Leave(KErrNotReady);
                        }
   iProgressBuf() = iProgress;
   return iProgressBuf;
   }

const TDesC8&amp; CTxtMtmForwardOperation::FinalProgress()
            {
    __ASSERT_ALWAYS(!IsActive(), User::Panic(KTxtCPanic,
                            ETxtcOperationIsActive));
            iProgressBuf() = iProgress;
   return iProgressBuf;
   }</pre>
 <p>The <a href="GUID-189483E6-31EA-32DF-8CD5-ECE58592DB3E.html"><span class="apiname">RunError()</span></a> function must also be
implemented to get any leaves in <a href="GUID-12C281FF-546C-318D-8783-F26B0F619E11.html"><span class="apiname">RunL()</span></a>. </p>
 <pre class="codeblock" id="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-D41E3F81-83E2-5F9C-BDB0-A97A4D9920A6"><a name="GUID-E180D222-CC4F-5007-93FC-C339BBE708BC__GUID-D41E3F81-83E2-5F9C-BDB0-A97A4D9920A6"><!-- --></a>TInt CTxtMtmForwardOperation::RunError(TInt aError)
    {
    iProgress.iError = aError;    
    TRequestStatus* stat = &amp;iObserverRequestStatus;
    User::RequestComplete(stat, aError);
    return KErrNone;
    }</pre>
 </div>

</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-400E4702-973A-5CAC-9F9C-3A10121F856A.html">Types of MTM</a></div>
</div>
<div class="relinfo relconcepts"><strong>Related concepts</strong><br/>
<div><a href="GUID-59217FA7-3078-53CA-88B3-78D6FB788271.html">MTM overview</a></div>
<div><a href="GUID-BAD138D5-2914-5C6E-9FA4-F7A3CCB85E6D.html">MTM Capabilities</a></div>
</div>
<div class="relinfo reltasks"><strong>Related tasks</strong><br/>
<div><a href="GUID-1E2DB50A-D8D7-595D-8448-77F057655E82.html">Writing a
Client MTM</a></div>
</div>
</div>   
<p class="copyright">Copyright &#169;2010 Nokia Corporation and/or its subsidiary(-ies).<br /> All rights
reserved. Unless otherwise stated, these materials are provided under the terms of the <a href=" http://www.eclipse.org/legal/epl-v10.html"> Eclipse Public License
v1.0</a>.</p> 
</div>
</div>
<?php include_once (CURRENT_SKIN_PATH.'/sdl_footer.html'); ?>

</body>
</html>